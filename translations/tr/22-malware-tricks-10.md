\newpage
\subsection{22. Belgelenmemiş NtAllocateVirtualMemory ile kod enjeksiyonu. Basit C++ örneği.}

﷽

![code injection](./images/30/2021-12-10_01-29.png){width="80%"}    

Bir önceki bölümde, belgelenmemiş `NtCreateThreadEx` ile DLL enjeksiyonundan bahsetmiştim.    

Bugün başka bir işlevi, örneğin `VirtualAllocEx`'i, belgelenmemiş NTAPI işlevi `NtAllocateVirtualMemory` ile değiştirmeyi denedim. İşte ortaya çıkan sonuç.
Şimdi, `WriteProcessMemory`, `CreateRemoteThread` gibi WINAPI işlevlerinden ve resmi olarak belgelenmemiş bir Native API olan `NtAllocateVirtualMemory`'den faydalanarak, payload'u uzak bir sürece nasıl enjekte edeceğimizi gösterelim.

İlk olarak, `NtAllocateVirtualMemory` işlevinin söz dizimine bakalım:    
```cpp
NTSYSAPI 
NTSTATUS
NTAPI NtAllocateVirtualMemory(
  IN HANDLE               ProcessHandle,
  IN OUT PVOID            *BaseAddress,
  IN ULONG                ZeroBits,
  IN OUT PULONG           RegionSize,
  IN ULONG                AllocationType,
  IN ULONG                Protect
);
```

Peki, bu işlev ne yapar? [Belgelerine](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory) göre, belirtilen bir sürecin kullanıcı modu sanal adres alanı içinde sayfaların bir bölgesini ayırır, taahhüt eder veya her ikisini yapar. Yani, Win API `VirtualAllocEx` ile benzer şekilde çalışır.   

`NtAllocateVirtualMemory` işlevini kullanabilmek için, kodumuzda tanımını belirtmemiz gerekiyor:    

![code injection 2](./images/30/2021-12-10_02-16.png){width="80%"}    

Daha sonra, `ntdll.dll` kütüphanesini yükleyip `NtAllocateVirtualMemory` işlevini çağıracağız:     

![code injection 3](./images/30/2021-12-10_02-20.png){width="80%"}    

Ve ardından işlevimizin başlangıç adresini alacağız:    

![code injection 4](./images/30/2021-12-10_02-22.png){width="80%"}    

Son olarak belleği tahsis edeceğiz:    

![code injection 5](./images/30/2021-12-10_02-23.png){width="80%"}    

Ve bunun dışında ana mantık aynı.     

![code injection 6](./images/30/2021-12-10_02-26.png){width="80%"}    

Bu kodta gösterildiği gibi, Windows API çağrısı bir Native API çağrısı ile değiştirilebilir. Örneğin, `VirtualAllocEx` yerine `NtAllocateVirtualMemory`, `WriteProcessMemory` yerine `NtWriteProcessMemory` kullanılabilir.    

Bu yöntemin dezavantajı, işlevin belgelenmemiş olmasıdır, bu yüzden gelecekte değişebilir.     

Şimdi basit zararlı yazılımımızı eylemde görelim. `hack.cpp`'yi derleyelim:      
```bash
x86_64-w64-mingw32-g++ hack.cpp -o hack.exe -mconsole \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ -static-libgcc \
-fpermissive
```

![code inection 7](./images/30/2021-12-10_02-30.png){width="80%"}    

Daha sonra Process Hacker 2'yi çalıştıralım:

![code injection 8](./images/30/2021-12-10_02-33.png){width="80%"}    

Örneğin, vurgulanan süreç `mspaint.exe` bizim kurbanımızdır.     

Basit zararlı yazılımımızı çalıştıralım:     

```powershell
.\hack.exe 6252
```

![code injection 9](./images/30/2021-12-10_02-36.png){width="80%"}    

Gördüğünüz gibi, `meow-meow` mesaj kutumuz açıldı.    

Kurban sürecimizin `PID` özelliklerini inceleyelim: `6252`:      

![code injection 10](./images/30/2021-12-10_02-50.png){width="80%"}    

Gördüğünüz gibi, `meow-meow` payload beklendiği gibi başarıyla enjekte edildi!     

Bu tekniği cephaneliğinizde bulundurmanın iyi bir nedeni, mavi takım üyeleri tarafından daha fazla araştırılan ve daha popüler olan `VirtualAllocEx`'i kullanmıyor olmamızdır.    

Umarım bu bölüm, bu ilginç teknik hakkında mavi takım üyelerine farkındalık kazandırır ve kırmızı takım üyelerinin cephaneliğine bir silah daha ekler.     

Bir sonraki bölümde, başka NT API işlevlerini ele almaya çalışacağım. Ana mantık aynı, ancak yapıların ve ilgili parametrelerin tanımlanmasıyla ilgili bir sorun var. Bu yapılar tanımlanmadan kod çalışmayacaktır.        

[VirtualAllocEx](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex)    
[NtAllocateVirtualMemory](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory)    
[WriteProcessMemory](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory)    
[CreateRemoteThread](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)    
[Github'taki kaynak kod:](https://github.com/cocomelonc/2021-12-07-malware-injection-10)    
