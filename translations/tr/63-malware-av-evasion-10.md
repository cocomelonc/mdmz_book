\newpage
\subsection{63. Malware AV/VM evasion - bölüm 10: anti-debugging. NtGlobalFlag. Basit C++ örneği.}

﷽

![av-evasion](./images/69/2022-09-15_16-30.png){width="80%"}      

Bu gönderi, `NtGlobalFlag` kontrolü ile ilgili ilginç bir anti-debugging tekniği üzerine yaptığım kendi araştırmamın sonucudur.       

Bu, kötü amaçlı yazılımların bir hata ayıklayıcı içinde çalıştığını tespit etmesinin bir başka yoludur.    

### NtGlobalFlag

Hata ayıklama sırasında, sistem `NtGlobalFlag` alanında bulunan `FLG_HEAP_ENABLE_TAIL_CHECK (0x10)`, `FLG_HEAP_ENABLE_FREE_CHECK (0x20)` ve `FLG_HEAP_VALIDATE_PARAMETERS (0x40)` bayraklarını ayarlar. Bu alan `PEB` yapısında yer almaktadır.      

`NtGlobalFlag`, `32-bit` Windows'ta `0x68` offset değerine, `64-bit` Windows'ta `0xbc` değerine sahiptir ve her ikisi de `0` olarak ayarlanmıştır:    

![av-evasion](./images/69/2022-09-15_16-07.png){width="80%"}      

### pratik örnek

Hata ayıklamaya karşı koruma için basit PoC kodu:     

```cpp
/*
hack.cpp
anti-debugging via NtGlobalFLag
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/15/malware-av-evasion-10.html
*/
#include <winternl.h>
#include <windows.h>
#include <stdio.h>

#define FLG_HEAP_ENABLE_TAIL_CHECK   0x10
#define FLG_HEAP_ENABLE_FREE_CHECK   0x20
#define FLG_HEAP_VALIDATE_PARAMETERS 0x40
#define NT_GLOBAL_FLAG_DEBUGGED (FLG_HEAP_ENABLE_TAIL_CHECK | 
FLG_HEAP_ENABLE_FREE_CHECK | FLG_HEAP_VALIDATE_PARAMETERS)

#pragma comment (lib, "user32.lib")

DWORD checkNtGlobalFlag() {
  PPEB ppeb = (PPEB)__readgsqword(0x60);
  DWORD myNtGlobalFlag = *(PDWORD)((PBYTE)ppeb + 0xBC);
  MessageBox(NULL, myNtGlobalFlag & NT_GLOBAL_FLAG_DEBUGGED ? "Bow-wow!" : 
  "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}

int main(int argc, char* argv[]) {
  DWORD check = checkNtGlobalFlag();
  return 0;
}
```

Gördüğünüz gibi, mantık oldukça basittir, sadece bayrakların bir kombinasyonunu kontrol ediyoruz.    

> Basitlik adına, yalnızca 64-bit Windows'u ele aldım.    

### demo

Hadi her şeyi çalışırken görelim. Derleyin:      

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![av-evasion](./images/69/2022-09-15_16-03.png){width="80%"}      

`x64dbg` hata ayıklayıcısı üzerinden çalıştırın:     

![av-evasion](./images/69/2022-09-15_16-31.png){width="80%"}      

ve cmd üzerinden çalıştırın:    

![av-evasion](./images/69/2022-09-15_16-32.png){width="80%"}      

Gördüğünüz gibi her şey mükemmel çalıştı :)    

VirusTotal'a yükleyin:    

![av-evasion](./images/69/2022-09-16_01-14.png){width="80%"}      

**Gördüğünüz gibi, 69 antivirüs motorundan 5'i PoC dosyamızı kötü amaçlı olarak tespit etti.**    

[https://www.virustotal.com/gui/file/6e0c2294a13f0b78e0526f217ee1a255ac3107123967e1fe9cd91cbbd8fd57dd/detection](https://www.virustotal.com/gui/file/6e0c2294a13f0b78e0526f217ee1a255ac3107123967e1fe9cd91cbbd8fd57dd/detection)     

Umarım bu gönderi, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.    

[MITRE ATT&CK: Debugger evasion](https://attack.mitre.org/techniques/T1622/)       
[MSDN: PEB structure](https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb)     
[x64dbg](https://github.com/x64dbg/x64dbg)     
[al-khaser](https://github.com/LordNoteworthy/al-khaser)    
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-09-15-malware-av-evasion-10)    
