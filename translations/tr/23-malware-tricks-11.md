\newpage
\subsection{23. belgelenmemiş Native API İşlevleri ile kod enjeksiyonu. Basit C++ örneği.}

﷽

![code injection](./images/31/2021-12-13_09-36.png){width="80%"}    

Önceki bölümlerde, belgelenmemiş `NtCreateThreadEx` ve `NtAllocateVirtualMemory` ile DLL enjeksiyonundan bahsetmiştim.     

Bu yazı, belgelenmemiş Native API ile etkileşimde bulunarak kötü amaçlı yazılım geliştirme tekniği üzerine kendi araştırmamın bir sonucudur.      

Bugün, `OpenProcess` işlevini, belgelenmemiş Native API işlevi `NtOpenProcess` ile değiştirmeyi denedim.     

Öncelikle, `NtOpenProcess` işlevinin söz dizimine bakalım:      

```cpp
__kernel_entry NTSYSCALLAPI NTSTATUS NtOpenProcess(
  [out]          PHANDLE            ProcessHandle,
  [in]           ACCESS_MASK        DesiredAccess,
  [in]           POBJECT_ATTRIBUTES ObjectAttributes,
  [in, optional] PCLIENT_ID         ClientId
);
```

Burada `ObjectAttributes` ve `ClientId` parametrelerine dikkat etmek gerekiyor.
`ObjectAttributes` - İşlem nesne tanıtıcısına uygulanacak öznitelikleri belirten bir `OBJECT_ATTRIBUTES` yapısına işaretçidir. Bu, tanıtıcıyı açmadan önce tanımlanmalı ve başlatılmalıdır. `ClientId` - Açılacak sürecin iş parçacığını tanımlayan bir istemci ID’sine işaretçidir.       

`NtOpenProcess` işlevini kullanabilmek için, kodumuzda tanımını belirtmemiz gerekiyor:    

![code injection 2](./images/31/2021-12-13_10-08.png){width="80%"}    

Benzer şekilde, `OBJECT_ATTRIBUTES` ve `PCLIENT_ID` yapıları da tanımlanmalıdır. Bu yapılar NT Kernel başlık dosyalarında tanımlıdır.    

`WinDBG`'yi yerel çekirdek modunda çalıştırabilir ve şunu çalıştırabiliriz:     

```bash
dt nt!_OBJECT_ATTRIBUTES
```

![code injection 2.2](./images/31/2021-12-13_11-18.png){width="80%"}    

![code injection 2.3](./images/31/2021-12-13_11-20.png){width="80%"}    

Daha sonra şu komutları çalıştırabiliriz:       

```bash
dt nt!_CLIENT_ID
```

![code injection 2.4](./images/31/2021-12-13_11-21.png){width="80%"}    

![code injection 2.5](./images/31/2021-12-13_11-22.png){width="80%"}    

Ve:

```bash
dt nt!_UNICODE_STRING
```

![code injection 2.5.1](./images/31/2021-12-13_13-30.png){width="80%"}    

![code injection 2.5.2](./images/31/2021-12-13_13-30_1.png){width="80%"}    

Ancak bir sorun daha var. `NtOpenProcess` işlevi/rotini tanıtıcıyı döndürmeden önce, tanıtıcıya uygulanacak nesne öznitelikleri başlatılmalıdır. Nesne özniteliklerini başlatmak için bir `IntitializeObjectAttributes` makrosu tanımlanır ve çağrılır. Bu makro, tanıtıcıları açan rutinlere bir nesne tanıtıcısının özelliklerini belirtir.

![code injection 2.5.3](./images/31/2021-12-13_11-48.png){width="80%"}    

![code injection 2.5.4](./images/31/2021-12-13_11-50.png){width="80%"}    

> [IntitializeObjectAttributes](https://docs.microsoft.com/en-us/windows/win32/api/ntdef/nf-ntdef-initializeobjectattributes)    

Daha sonra, `ntdll.dll` kütüphanesini yükleyerek `NtOpenProcess` işlevini çağırıyoruz:        

![code injection 3](./images/31/2021-12-13_11-31.png){width="80%"}    

Ve ardından işlevimizin başlangıç adreslerini alıyoruz:    

![code injection 4](./images/31/2021-12-13_11-45.png){width="80%"}    

Son olarak, süreci açıyoruz:     

![code injection 5](./images/31/2021-12-13_11-46.png){width="80%"}    

Ve bunun dışında ana mantık aynı.    

![code injection 6](./images/31/2021-12-13_11-49.png){width="80%"}    

Bu kodda gösterildiği gibi, Windows API çağrısı `OpenProcess`, Native API işlevi `NtOpenProcess` ile değiştirilebilir. Ancak, NT çekirdek başlık dosyalarında tanımlı olan yapıların da tanımlanması gerekir.     

Bu yöntemin dezavantajı, işlevin belgelenmemiş olmasıdır, bu yüzden gelecekte değişebilir.     

Şimdi basit zararlı yazılımımızı eylemde görelim. `hack.cpp`'yi derleyelim:       

```bash
x86_64-w64-mingw32-g++ hack.cpp -o hack.exe -mconsole \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ -static-libgcc \
-fpermissive
```

![code inection 7](./images/31/2021-12-13_12-40.png){width="80%"}    

Daha sonra Process Hacker 2'yi çalıştıralım:     

![code injection 8](./images/31/2021-12-13_12-44.png){width="80%"}    

Örneğin, vurgulanan süreç `mspaint.exe` bizim kurbanımızdır.    

Basit zararlı yazılımımızı çalıştıralım:    

```powershell
.\hack.exe 4964
```

![code injection 9](./images/31/2021-12-13_12-46.png){width="80%"}    

Gördüğünüz gibi, `meow-meow` mesaj kutumuz açıldı.       

Kurban sürecimizin `PID` özelliklerini inceleyelim: `4964`:     

![code injection 10](./images/31/2021-12-13_12-50.png){width="80%"}    

Gördüğünüz gibi, `meow-meow` payload beklendiği gibi başarıyla enjekte edildi!    

Gördüğünüz gibi, ana mantık önceki NT API işlev çağrısı teknikleriyle aynı, ancak yapıların ve ilgili parametrelerin tanımlanmasıyla ilgili bir sorun var. Bu yapılar tanımlanmadığı sürece kod çalışmaz.    

Bu tekniği cephaneliğinizde bulundurmanın iyi bir nedeni, mavi takım üyeleri tarafından daha fazla araştırılan ve daha popüler olan `OpenProcess`'i kullanmıyor olmamızdır.      

13.12.2021'de şifrelenmiş bir komutla yeni `hack.exe` dosyamızı Virustotal'a yükleyelim:    

![code injection 11](./images/31/2021-12-13_13-01.png){width="80%"}    

[https://www.virustotal.com/gui/file/9f4213643891fc14473948deb15077d9b7b4d2da3db467932e57e7e383e535e6?nocache=1](https://www.virustotal.com/gui/file/9f4213643891fc14473948deb15077d9b7b4d2da3db467932e57e7e383e535e6?nocache=1)    

**Gördüğünüz gibi, 65 antivirüs motorundan 5 tanesi dosyamızı zararlı olarak algıladı.** 

Daha iyi sonuçlar için, [payload şifrelemesini](https://cocomelonc.github.io/tutorial/2021/09/04/simple-malware-av-evasion.html) bir anahtar ile ekleyebilir, işlevleri [gizleyebilir](https://cocomelonc.github.io/tutorial/2021/09/06/simple-malware-av-evasion-2.html) veya her iki tekniği birleştirebilirsiniz.     

Umarım bu bölüm, bu ilginç teknik hakkında mavi takım üyelerine farkındalık kazandırır ve kırmızı takım üyelerinin cephaneliğine bir silah daha ekler.    

[WinDBG kernel debugging](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/performing-local-kernel-debugging)    
[VirtualAllocEx](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex)    
[NtOpenProcess](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/nf-ntddk-ntopenprocess)    
[NtAllocateVirtualMemory](https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntallocatevirtualmemory)    
[WriteProcessMemory](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory)    
[CreateRemoteThread](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)    
[Github'taki kaynak kod](https://github.com/cocomelonc/2021-12-11-malware-injection-11)    
